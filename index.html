<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PathLife - æ•…äº‹åœ°å›¾</title>
    <!-- å¼•å…¥é«˜å¾·åœ°å›¾JS API -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=cbe4d15c534a63b892ad057a299f88d2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; }
        body { display: flex; height: 100vh; background: #f5f7fa; color: #333; }
        #mapContainer { flex: 1; height: 100%; }
        #sidebar { width: 380px; background: white; border-left: 1px solid #e1e5eb; display: flex; flex-direction: column; }
        .logo { padding: 20px; border-bottom: 1px solid #e1e5eb; }
        .logo h1 { font-size: 1.5rem; color: #2c3e50; }
        .logo p { color: #7f8c8d; font-size: 0.9rem; margin-top: 5px; }
        .search-box { padding: 20px; border-bottom: 1px solid #e1e5eb; }
        .search-container { display: flex; gap: 10px; }
        #searchInput { flex: 1; padding: 12px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        #searchButton { background: #3498db; color: white; border: none; border-radius: 8px; padding: 0 20px; cursor: pointer; font-weight: bold; }
        #searchButton:hover { background: #2980b9; }
        #searchResults { max-height: 300px; overflow-y: auto; margin-top: 10px; border: 1px solid #eee; border-radius: 8px; display: none; }
        .result-item { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .result-item:hover { background: #f8f9fa; }
        .result-item h4 { color: #2c3e50; margin-bottom: 5px; }
        .result-item p { color: #666; font-size: 0.9rem; }
        .stories-list { flex: 1; overflow-y: auto; padding: 20px; }
        .story-card { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 10px; padding: 15px; margin-bottom: 15px; cursor: pointer; }
        .story-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-2px); }
        .story-card.active { border-color: #3498db; background: #e3f2fd; }
        .story-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .story-title { font-weight: bold; color: #2c3e50; }
        .story-time { color: #95a5a6; font-size: 0.8rem; }
        .story-location { color: #3498db; font-size: 0.9rem; margin-bottom: 8px; }
        .story-preview { color: #666; font-size: 0.9rem; line-height: 1.4; max-height: 60px; overflow: hidden; }
        #editorModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .editor-content { width: 90%; max-width: 800px; height: 80%; background: white; border-radius: 15px; display: flex; flex-direction: column; overflow: hidden; }
        .editor-header { padding: 20px; border-bottom: 1px solid #eee; }
        .editor-header h2 { color: #2c3e50; }
        .editor-header .location-info { color: #7f8c8d; font-size: 0.9rem; margin-top: 5px; }
        .editor-toolbar { padding: 10px 20px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; gap: 10px; }
        .editor-toolbar button { padding: 8px 15px; background: white; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; }
        #storyEditor { flex: 1; padding: 20px; font-size: 1rem; line-height: 1.6; overflow-y: auto; outline: none; border: none; min-height: 200px; }
        .editor-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
        .editor-footer button { padding: 10px 25px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        #saveStory { background: #3498db; color: white; }
        #saveStory:hover { background: #2980b9; }
        #closeEditor { background: #ecf0f1; color: #333; }
        #closeEditor:hover { background: #d5dbdb; }
        #toggleRoute { position: absolute; top: 20px; left: 20px; z-index: 10; background: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; color: #2c3e50; }
        .status-box { background: #e8f4fd; border: 1px solid #b6e0fe; border-radius: 8px; padding: 15px; margin: 0 20px 15px; font-size: 0.9rem; }
        .status-box.success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .loading { text-align: center; padding: 10px; color: #7f8c8d; font-size: 0.9rem; }
        @media (max-width: 768px) {
            body { flex-direction: column; }
            #sidebar { width: 100%; height: 45%; border-left: none; border-top: 1px solid #e1e5eb; }
            #mapContainer { height: 55%; }
        }
    </style>
</head>
<body>
    <div id="mapContainer"></div>
    <button id="toggleRoute">ğŸ“ æ˜¾ç¤ºè·¯çº¿å›¾</button>
    <div id="sidebar">
        <div class="logo">
            <h1>ğŸ—ºï¸ PathLife æ•…äº‹åœ°å›¾</h1>
            <p>è®°å½•æ—…ç¨‹ï¼Œä¸²è”æ¯ä¸ªæ•…äº‹ç¬é—´</p>
        </div>
        <div class="status-box success" id="keyStatus">
            âœ… API Key å·²ç”Ÿæ•ˆ (æœåŠ¡å·²å¼€é€š)
        </div>
        <div class="search-box">
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="æœç´¢åœ°ç‚¹ï¼Œå¦‚ï¼šæ•…å®«åšç‰©é™¢ã€ä¸Šæµ·å¤–æ»©...">
                <button id="searchButton">æœç´¢</button>
            </div>
            <div id="searchResults"></div>
        </div>
        <div class="stories-list" id="storiesList"></div>
    </div>
    <div id="editorModal">
        <div class="editor-content">
            <div class="editor-header">
                <h2>âœï¸ ç¼–è¾‘æ•…äº‹</h2>
                <div class="location-info" id="editorLocation"></div>
            </div>
            <div class="editor-toolbar">
                <button onclick="formatText('bold')"><b>B</b></button>
                <button onclick="formatText('italic')"><i>I</i></button>
                <button onclick="formatText('insertUnorderedList')">ğŸ“‹ åˆ—è¡¨</button>
                <button onclick="insertImage()">ğŸ–¼ï¸ å›¾ç‰‡</button>
            </div>
            <div id="storyEditor" contenteditable="true" placeholder="å†™ä¸‹ä½ çš„æ•…äº‹..."></div>
            <div class="editor-footer">
                <button id="closeEditor">å–æ¶ˆ</button>
                <button id="saveStory">ä¿å­˜æ•…äº‹</button>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®
        const AMapKey = '0874b5c6096d30f6f75ae6949f5c4468';
        
        // å…¨å±€å˜é‡
        let map = null;
        let markers = [];
        let currentPlace = null;
        let editingStoryId = null;
        let routeLine = null;
        let isRouteVisible = false;
        let placeSearch = null;
        let stories = JSON.parse(localStorage.getItem('pathLifeStories')) || [];

        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            map = new AMap.Map('mapContainer', {
                zoom: 12,
                center: [116.397428, 39.90923],
                viewMode: '2D',
                resizeEnable: true
            });
            
            console.log('åœ°å›¾åˆå§‹åŒ–æˆåŠŸï¼ŒKey:', AMapKey.substring(0, 8) + '...');
            
            // åŠ è½½å·²æœ‰æ•…äº‹
            loadStoriesOnMap();
            renderStoryList();
            
            // åˆå§‹åŒ–æœç´¢åŠŸèƒ½
            initSearch();
        }

        // åˆå§‹åŒ–æœç´¢
        function initSearch() {
            AMap.plugin('AMap.PlaceSearch', function() {
                placeSearch = new AMap.PlaceSearch({
                    pageSize: 10,
                    city: 'å…¨å›½',
                    citylimit: false,
                    extensions: 'base'
                });
                console.log('æœç´¢åŠŸèƒ½åˆå§‹åŒ–æˆåŠŸ');
            });
        }

        // æ‰§è¡Œæœç´¢
        function performSearch() {
            const keyword = document.getElementById('searchInput').value.trim();
            const resultsContainer = document.getElementById('searchResults');
            
            if (!keyword) {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }
            
            if (!placeSearch) {
                alert('æœç´¢åŠŸèƒ½æ­£åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨å€™...');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            resultsContainer.innerHTML = '<div class="loading">æœç´¢ä¸­...</div>';
            resultsContainer.style.display = 'block';
            
            // æ‰§è¡Œæœç´¢
            placeSearch.search(keyword, function(status, result) {
                if (status === 'complete' && result.info === 'OK') {
                    const pois = result.poiList.pois;
                    displaySearchResults(pois, resultsContainer);
                    
                    // å¦‚æœæœ‰ç»“æœï¼Œå®šä½åˆ°ç¬¬ä¸€ä¸ª
                    if (pois.length > 0) {
                        map.setCenter([pois[0].location.lng, pois[0].location.lat]);
                        map.setZoom(15);
                    }
                } else {
                    resultsContainer.innerHTML = `
                        <div class="result-item">
                            <p style="color:#e74c3c;">æœç´¢å¤±è´¥</p>
                            <p style="font-size:0.9rem;color:#666;">çŠ¶æ€: ${status}, ä¿¡æ¯: ${result.info || 'æœªçŸ¥é”™è¯¯'}</p>
                        </div>`;
                }
            });
        }

        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displaySearchResults(pois, container) {
            if (pois.length === 0) {
                container.innerHTML = '<div class="result-item"><p>æœªæ‰¾åˆ°ç›¸å…³åœ°ç‚¹</p></div>';
                return;
            }
            
            container.innerHTML = pois.map(poi => `
                <div class="result-item" data-lng="${poi.location.lng}" data-lat="${poi.location.lat}">
                    <h4>${poi.name}</h4>
                    <p>${poi.address || poi.pname + poi.cityname + poi.adname}</p>
                    <button onclick="selectPlaceFromResult(this)" style="background:#3498db;color:white;border:none;padding:4px 12px;border-radius:4px;margin-top:8px;cursor:pointer;font-size:0.8rem;">
                        é€‰æ‹©æ­¤åœ°
                    </button>
                </div>
            `).join('');
        }

        // é€‰æ‹©åœ°ç‚¹
        function selectPlaceFromResult(button) {
            const item = button.closest('.result-item');
            const place = {
                name: item.querySelector('h4').textContent,
                address: item.querySelector('p').textContent,
                location: {
                    lng: parseFloat(item.dataset.lng),
                    lat: parseFloat(item.dataset.lat)
                }
            };
            
            currentPlace = place;
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('searchInput').value = place.name;
            
            // æ¸…é™¤æ—§æ ‡è®°ï¼Œæ·»åŠ æ–°æ ‡è®°
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            
            const marker = new AMap.Marker({
                position: [place.location.lng, place.location.lat],
                map: map,
                title: place.name,
                animation: "AMAP_ANIMATION_DROP"
            });
            markers.push(marker);
            
            map.setCenter([place.location.lng, place.location.lat]);
            map.setZoom(16);
            
            // æ‰“å¼€ç¼–è¾‘å™¨
            openEditor(place);
        }

        // æ‰“å¼€ç¼–è¾‘å™¨
        function openEditor(place, storyId = null) {
            editingStoryId = storyId;
            document.getElementById('editorLocation').textContent = `åœ°ç‚¹ï¼š${place.name}`;
            
            const editor = document.getElementById('storyEditor');
            if (storyId) {
                const story = stories.find(s => s.id === storyId);
                editor.innerHTML = story?.content || '';
            } else {
                editor.innerHTML = '';
            }
            
            document.getElementById('editorModal').style.display = 'flex';
            setTimeout(() => editor.focus(), 100);
        }

        // ä¿å­˜æ•…äº‹
        function saveStory() {
            if (!currentPlace) return;
            
            const editor = document.getElementById('storyEditor');
            const content = editor.innerHTML.trim();
            const textContent = editor.innerText.trim();
            
            if (!textContent) {
                alert('è¯·è¾“å…¥æ•…äº‹å†…å®¹');
                return;
            }
            
            const storyData = {
                id: editingStoryId || Date.now().toString(),
                title: textContent.substring(0, 30) || 'æˆ‘çš„æ•…äº‹',
                placeName: currentPlace.name,
                lng: currentPlace.location.lng,
                lat: currentPlace.location.lat,
                address: currentPlace.address,
                content: content,
                time: new Date().toLocaleString(),
                timestamp: Date.now()
            };
            
            // æ›´æ–°æˆ–æ·»åŠ æ•…äº‹
            const index = stories.findIndex(s => s.id === storyData.id);
            if (index > -1) {
                stories[index] = storyData;
            } else {
                stories.push(storyData);
            }
            
            // æŒ‰æ—¶é—´æ’åº
            stories.sort((a, b) => b.timestamp - a.timestamp);
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('pathLifeStories', JSON.stringify(stories));
            
            // æ›´æ–°ç•Œé¢
            loadStoriesOnMap();
            renderStoryList();
            closeEditor();
            
            alert('âœ… æ•…äº‹å·²ä¿å­˜ï¼');
        }

        // åœ¨åœ°å›¾ä¸ŠåŠ è½½æ•…äº‹æ ‡è®°
        function loadStoriesOnMap() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            
            stories.forEach(story => {
                const marker = new AMap.Marker({
                    position: [story.lng, story.lat],
                    map: map,
                    title: story.placeName
                });
                
                marker.on('click', () => {
                    highlightStoryCard(story.id);
                    const infoWindow = new AMap.InfoWindow({
                        content: `
                            <div style="padding:10px;max-width:250px;">
                                <h4 style="margin:0 0 5px 0;">${story.placeName}</h4>
                                <p style="color:#666;font-size:12px;margin:0 0 8px 0;">${story.time}</p>
                                <p style="font-size:13px;line-height:1.4;">${story.content.replace(/<[^>]+>/g, '').substring(0, 80)}...</p>
                                <button onclick="editStory('${story.id}')" style="background:#3498db;color:white;border:none;padding:5px 10px;border-radius:4px;margin-top:8px;cursor:pointer;">ç¼–è¾‘</button>
                            </div>
                        `
                    });
                    infoWindow.open(map, [story.lng, story.lat]);
                });
                
                markers.push(marker);
            });
            
            updateRouteLine();
        }

        // æ¸²æŸ“æ•…äº‹åˆ—è¡¨
        function renderStoryList() {
            const container = document.getElementById('storiesList');
            
            if (stories.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;padding:40px 20px;color:#95a5a6;">
                        <p style="font-size:1.2rem;margin-bottom:10px;">è¿˜æ²¡æœ‰æ•…äº‹è®°å½•</p>
                        <p>æœç´¢ä¸€ä¸ªåœ°ç‚¹ï¼Œå¼€å§‹è®°å½•ä½ çš„æ—…ç¨‹å§ï¼</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = stories.map(story => `
                <div class="story-card" data-id="${story.id}" onclick="focusOnStory('${story.id}')">
                    <div class="story-header">
                        <div class="story-title">${story.title}</div>
                        <div class="story-time">${story.time}</div>
                    </div>
                    <div class="story-location">ğŸ“ ${story.placeName}</div>
                    <div class="story-preview">${story.content.replace(/<[^>]+>/g, '').substring(0, 100)}...</div>
                </div>
            `).join('');
        }

        // èšç„¦åˆ°æ•…äº‹åœ°ç‚¹
        function focusOnStory(storyId) {
            const story = stories.find(s => s.id === storyId);
            if (story) {
                map.setCenter([story.lng, story.lat]);
                map.setZoom(16);
                highlightStoryCard(storyId);
            }
        }

        // é«˜äº®æ•…äº‹å¡ç‰‡
        function highlightStoryCard(storyId) {
            document.querySelectorAll('.story-card').forEach(card => {
                card.classList.remove('active');
            });
            const card = document.querySelector(`.story-card[data-id="${storyId}"]`);
            if (card) card.classList.add('active');
        }

        // ç¼–è¾‘æ•…äº‹
        function editStory(storyId) {
            const story = stories.find(s => s.id === storyId);
            if (!story) return;
            
            currentPlace = {
                name: story.placeName,
                location: { lng: story.lng, lat: story.lat },
                address: story.address
            };
            
            openEditor(currentPlace, storyId);
        }

        // æ›´æ–°è·¯çº¿è¿çº¿
        function updateRouteLine() {
            if (routeLine) {
                map.remove(routeLine);
                routeLine = null;
            }
            
            if (stories.length < 2 || !isRouteVisible) return;
            
            const sortedStories = [...stories].sort((a, b) => a.timestamp - b.timestamp);
            const linePath = sortedStories.map(s => [s.lng, s.lat]);
            
            routeLine = new AMap.Polyline({
                path: linePath,
                strokeColor: "#3498db",
                strokeOpacity: 0.8,
                strokeWeight: 4,
                strokeStyle: "solid"
            });
            
            map.add(routeLine);
            map.setFitView();
        }

        // åˆ‡æ¢è·¯çº¿æ˜¾ç¤º
        function toggleRoute() {
            isRouteVisible = !isRouteVisible;
            document.getElementById('toggleRoute').textContent = 
                isRouteVisible ? 'ğŸ“ éšè—è·¯çº¿å›¾' : 'ğŸ“ æ˜¾ç¤ºè·¯çº¿å›¾';
            updateRouteLine();
        }

        // ç¼–è¾‘å™¨åŠŸèƒ½
        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('storyEditor').focus();
        }
        
        function insertImage() {
            const url = prompt('è¯·è¾“å…¥å›¾ç‰‡URLï¼ˆéœ€ä»¥http://æˆ–https://å¼€å¤´ï¼‰:');
            if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
                document.execCommand('insertHTML', false, 
                    `<img src="${url}" style="max-width:100%;border-radius:8px;margin:10px 0;" alt="å›¾ç‰‡">`);
            } else if (url) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡URL');
            }
        }

        // å…³é—­ç¼–è¾‘å™¨
        function closeEditor() {
            document.getElementById('editorModal').style.display = 'none';
            document.getElementById('storyEditor').innerHTML = '';
            editingStoryId = null;
            currentPlace = null;
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof AMap === 'undefined') {
                alert('é«˜å¾·åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
                return;
            }
            
            initMap();
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('searchButton').addEventListener('click', performSearch);
            document.getElementById('searchInput').addEventListener('keydown', function(e) {
                if (e.keyCode === 13) performSearch();
            });
            document.getElementById('saveStory').addEventListener('click', saveStory);
            document.getElementById('closeEditor').addEventListener('click', closeEditor);
            document.getElementById('toggleRoute').addEventListener('click', toggleRoute);
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            document.getElementById('editorModal').addEventListener('click', function(e) {
                if (e.target === this) closeEditor();
            });
            
            console.log('PathLife æ•…äº‹åœ°å›¾å·²åŠ è½½å®Œæˆ');
        });
    </script>
</body>
</html>
