<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PathLife - æ•…äº‹åœ°å›¾</title>
    <!-- å¼•å…¥é«˜å¾·åœ°å›¾JS API -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=0874b5c6096d30f6f75ae6949f5c4468"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Helvetica Neue', 'Segoe UI', 'Microsoft YaHei', sans-serif; }
        html, body { height: 100%; width: 100%; overflow: hidden; touch-action: manipulation; }
        body { display: flex; flex-direction: column; background: #f5f7fa; color: #333; }
        
        /* å¯¼èˆªæ æ ·å¼ */
        #navbar {
            background: white;
            border-bottom: 1px solid #e1e5eb;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            z-index: 100;
            height: 70px; /* å›ºå®šå¯¼èˆªæ é«˜åº¦ */
        }
        
        .nav-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            overflow: hidden;
        }
        
        .nav-right {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .logo {
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 0;
        }
        
        .logo h1 {
            font-size: 1.3rem;
            color: #2c3e50;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }
        
        .logo p {
            color: #7f8c8d;
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }
        
        /* å­˜å‚¨ä¿¡æ¯æ ·å¼ - åœ¨å¯¼èˆªæ ä¸­ */
        .storage-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.8rem;
            min-width: 200px;
            flex-shrink: 0;
        }
        
        .storage-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .storage-info-header span {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .storage-info progress {
            width: 100%;
            height: 6px;
            margin: 4px 0;
        }
        
        .storage-info-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: #666;
        }
        
        /* åœ°å›¾å®¹å™¨ - å æ»¡å‰©ä½™ç©ºé—´ */
        #mapContainer {
            flex: 1;
            width: 100%;
            min-height: 0;
            position: relative;
        }
        
        /* æ§åˆ¶æŒ‰é’®æ ·å¼ - è°ƒæ•´ä½ç½®é¿å…è¢«å¯¼èˆªæ é®æŒ¡ */
        #toggleRoute, #recordStory, #storyListButton, #manageData, #locateButton {
            position: absolute;
            z-index: 10;
            background: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #2c3e50;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 0.9rem;
            padding: 10px 15px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        #toggleRoute { top: 85px; left: 15px; } /* ä»15pxè°ƒæ•´ä¸º85pxï¼Œé¿å…è¢«å¯¼èˆªæ é®æŒ¡ */
        #recordStory { top: 85px; right: 15px; background: #2ecc71; color: white; } /* ä»15pxè°ƒæ•´ä¸º85px */
        #storyListButton { top: 130px; right: 15px; background: #9b59b6; color: white; } /* ä»60pxè°ƒæ•´ä¸º130px */
        #manageData { top: 175px; right: 15px; background: #f39c12; color: white; } /* ä»105pxè°ƒæ•´ä¸º175px */
        #locateButton { bottom: 15px; right: 15px; background: #3498db; color: white; }
        
        /* ä¾§è¾¹æ æ ·å¼ - é»˜è®¤éšè— */
        #sidebar {
            position: absolute;
            top: 70px; /* ä»0è°ƒæ•´ä¸º70pxï¼Œä»å¯¼èˆªæ ä¸‹æ–¹å¼€å§‹ */
            right: 0;
            width: 0;
            height: calc(100% - 70px); /* é«˜åº¦å‡å»å¯¼èˆªæ é«˜åº¦ */
            background: white;
            border-left: 1px solid #e1e5eb;
            overflow: hidden;
            transition: width 0.3s ease;
            z-index: 50;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        }
        
        #sidebar.sidebar-open {
            width: 350px;
            max-width: 90%;
        }
        
        .sidebar-content {
            width: 350px;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-toggle {
            position: absolute;
            top: 85px; /* ä»80pxè°ƒæ•´ä¸º85pxï¼Œåœ¨å¯¼èˆªæ ä¸‹æ–¹ */
            right: 0;
            z-index: 20;
            background: white;
            border: none;
            border-radius: 8px 0 0 8px;
            cursor: pointer;
            box-shadow: -2px 2px 6px rgba(0,0,0,0.1);
            font-size: 1.2rem;
            padding: 10px 8px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .location-box {
            padding: 15px;
            border-bottom: 1px solid #e1e5eb;
            flex-shrink: 0;
        }
        
        .location-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        #currentLocationInfo {
            background: #f8f9fa;
            border: 1px solid #e1e5eb;
            border-radius: 8px;
            padding: 12px;
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        #currentLocationInfo h3 {
            color: #2c3e50;
            margin-bottom: 6px;
            font-size: 0.95rem;
        }
        
        #currentLocationInfo p {
            color: #666;
            margin: 3px 0;
            font-size: 0.8rem;
        }
        
        .stories-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            -webkit-overflow-scrolling: touch;
        }
        
        .story-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
            cursor: pointer;
        }
        
        .story-card.active {
            border-color: #3498db;
            background: #e3f2fd;
        }
        
        .story-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .story-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95rem;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .story-time {
            color: #95a5a6;
            font-size: 0.75rem;
            flex-shrink: 0;
            margin-left: 8px;
        }
        
        .story-location {
            color: #3498db;
            font-size: 0.85rem;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
        }
        
        .story-preview {
            color: #666;
            font-size: 0.85rem;
            line-height: 1.3;
            max-height: 40px;
            overflow: hidden;
        }
        
        /* çŠ¶æ€æç¤ºæ¡† */
        .status-box {
            background: #e8f4fd;
            border: 1px solid #b6e0fe;
            border-radius: 8px;
            padding: 12px;
            margin: 0 15px 12px;
            font-size: 0.85rem;
        }
        
        .status-box.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .status-box.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .status-box.warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        
        /* åœ°å›¾åŠ è½½çŠ¶æ€ */
        .map-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            background: #f0f2f5;
            color: #666;
            font-size: 1rem;
        }
        
        #mapLoading { display: none; }
        
        /* æ—¥æœŸåˆ†ç»„æ ·å¼ */
        .date-group {
            margin-bottom: 20px;
        }
        
        .date-header {
            position: sticky;
            top: 0;
            background: white;
            padding: 10px 15px;
            margin: 15px 0 10px 0;
            border-bottom: 2px solid #3498db;
            font-weight: 600;
            color: #2c3e50;
            z-index: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .date-header .date-count {
            float: right;
            background: #3498db;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: normal;
        }
        
        .date-header .date-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 2px;
            font-weight: normal;
        }
        
        .story-group {
            margin-bottom: 5px;
        }
        
        .empty-date-group {
            text-align: center;
            padding: 30px 15px;
            color: #95a5a6;
        }
        
        .empty-date-group p:first-child {
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        
        .empty-date-group p:last-child {
            font-size: 0.9rem;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; border-radius: 15px; width: 90%; max-width: 400px; margin: 10% auto; padding: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { margin-bottom: 20px; }
        .modal-header h3 { color: #2c3e50; text-align: center; font-size: 1.2rem; }
        .modal-options { display: flex; flex-direction: column; gap: 15px; }
        .modal-option { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 10px; padding: 15px; text-align: center; cursor: pointer; }
        .modal-option i { font-size: 1.8rem; margin-bottom: 8px; color: #3498db; }
        .modal-option span { display: block; font-weight: 600; color: #2c3e50; font-size: 1rem; }
        .modal-option p { font-size: 0.85rem; color: #7f8c8d; margin-top: 5px; }
        .modal-footer { margin-top: 20px; display: flex; gap: 10px; }
        .modal-footer button { flex: 1; padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 1rem; }
        
        /* ç¼–è¾‘å™¨æ¨¡æ€æ¡† */
        #editorModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; }
        .editor-content { width: 100%; height: 100%; background: white; display: flex; flex-direction: column; }
        .editor-header { padding: 20px 15px; border-bottom: 1px solid #eee; position: relative; }
        .editor-header h2 { color: #2c3e50; font-size: 1.2rem; }
        .editor-header .location-info { color: #7f8c8d; font-size: 0.85rem; margin-top: 5px; line-height: 1.3; }
        .editor-toolbar { padding: 12px 15px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; gap: 8px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .editor-toolbar button { padding: 8px 12px; background: white; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 0.9rem; flex-shrink: 0; }
        #storyEditor { flex: 1; padding: 15px; font-size: 1rem; line-height: 1.5; overflow-y: auto; outline: none; border: none; min-height: 200px; -webkit-overflow-scrolling: touch; }
        .editor-footer { padding: 15px; border-top: 1px solid #eee; display: flex; justify-content: space-between; gap: 10px; }
        .editor-footer button { padding: 12px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 1rem; flex: 1; }
        #saveStory { background: #3498db; color: white; }
        #closeEditor { background: #ecf0f1; color: #333; }
        
        /* æ•…äº‹åˆ—è¡¨æ¨¡æ€æ¡† */
        .story-list-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .story-list-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 95%;
            max-width: 800px;
            height: 90%;
            max-height: 800px;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .story-list-header {
            padding: 20px;
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
            position: relative;
        }

        .story-list-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .story-list-header p {
            margin: 5px 0 0 0;
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .close-story-list {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
            transition: background 0.2s;
        }

        .close-story-list:hover {
            background: rgba(255,255,255,0.3);
        }

        .story-list-filters {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px 12px 40px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
        }

        .search-box span {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
        }

        .filter-options {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .filter-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: #9b59b6;
            color: white;
            border-color: #9b59b6;
        }

        .filter-btn:hover:not(.active) {
            background: #f8f9fa;
        }

        .story-list-container {
            flex: 1;
            overflow-y: auto;
            padding: 0 20px;
        }

        .story-list-date-group {
            margin-bottom: 25px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .story-list-date-header {
            position: sticky;
            top: 0;
            background: white;
            padding: 15px 0 10px 0;
            border-bottom: 2px solid #9b59b6;
            margin-bottom: 10px;
            z-index: 2;
        }

        .story-list-date-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .story-list-date-subtitle {
            font-size: 0.9rem;
            color: #7f8c8d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .story-list-date-count {
            background: #9b59b6;
            color: white;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
        }

        .story-list-story {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .story-list-story:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-color: #9b59b6;
        }

        .story-list-story-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .story-list-story-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding-right: 10px;
        }

        .story-list-story-time {
            color: #95a5a6;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .story-list-story-location {
            color: #3498db;
            font-size: 0.9rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        .story-list-story-preview {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
            max-height: 60px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            margin-bottom: 10px;
        }

        .story-list-story-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .story-list-story-action-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .story-list-story-action-btn.edit {
            background: #3498db;
            color: white;
        }

        .story-list-story-action-btn.delete {
            background: #e74c3c;
            color: white;
        }

        .story-list-story-action-btn:hover {
            opacity: 0.9;
            transform: scale(0.98);
        }

        .story-list-empty {
            text-align: center;
            padding: 50px 20px;
            color: #95a5a6;
        }

        .story-list-empty-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .story-list-empty h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        .story-list-empty p {
            font-size: 0.95rem;
            margin-bottom: 20px;
        }

        .story-list-footer {
            padding: 15px 20px;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .story-stats {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
        }

        .story-stats span {
            font-weight: 600;
            color: #9b59b6;
        }
        
        /* ç¡®è®¤å¯¹è¯æ¡† */
        .confirm-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; }
        .confirm-content { background: white; border-radius: 15px; width: 85%; max-width: 350px; margin: 30% auto; padding: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .confirm-content h3 { margin-bottom: 15px; color: #2c3e50; text-align: center; }
        .confirm-message { margin-bottom: 20px; color: #666; font-size: 0.95rem; line-height: 1.4; }
        .confirm-buttons { display: flex; gap: 10px; }
        .confirm-buttons button { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem; }
        .confirm-cancel { background: #95a5a6; color: white; }
        .confirm-ok { background: #e74c3c; color: white; }
        
        /* å›¾ç‰‡ä¸Šä¼ æ ·å¼ */
        .image-upload-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2500; }
        .image-upload-content { background: white; border-radius: 15px; width: 90%; max-width: 400px; margin: 20% auto; padding: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .image-upload-content h3 { margin-bottom: 20px; color: #2c3e50; text-align: center; font-size: 1.2rem; }
        .upload-options { display: flex; flex-direction: column; gap: 15px; }
        .upload-option { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; }
        .upload-option i { font-size: 2rem; margin-bottom: 10px; color: #3498db; }
        .upload-option span { display: block; font-weight: 600; color: #2c3e50; font-size: 1rem; }
        .upload-option p { font-size: 0.85rem; color: #7f8c8d; margin-top: 5px; }
        #cameraInput, #fileInput { display: none; }
        .close-upload { background: #e74c3c; color: white; border: none; border-radius: 8px; padding: 12px; margin-top: 20px; width: 100%; cursor: pointer; font-weight: 600; font-size: 1rem; }
        .image-preview { max-width: 100%; max-height: 200px; border-radius: 8px; margin: 10px 0; display: none; }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .nav-right {
                display: none; /* åœ¨å°å±å¹•ä¸Šéšè—å¯¼èˆªæ å³ä¾§æŒ‰é’®ï¼Œé€šè¿‡åœ°å›¾ä¸Šçš„æŒ‰é’®ä»£æ›¿ */
            }
            
            #navbar {
                padding: 10px 12px;
                height: 60px; /* å°å±å¹•ä¸Šå‡å°‘é«˜åº¦ */
            }
            
            .logo h1 {
                font-size: 1.1rem;
            }
            
            .logo p {
                font-size: 0.75rem;
            }
            
            .storage-info {
                min-width: 160px;
                padding: 6px 10px;
            }
            
            #sidebar {
                top: 60px; /* è°ƒæ•´ä¾§è¾¹æ ä½ç½® */
                height: calc(100% - 60px);
            }
            
            #sidebar.sidebar-open {
                width: 100%;
                max-width: 100%;
            }
            
            /* ç§»åŠ¨ç«¯æŒ‰é’®ä½ç½®è°ƒæ•´ */
            #toggleRoute, #recordStory { top: 70px; }
            #storyListButton { top: 115px; }
            #manageData { top: 160px; }
            .sidebar-toggle { top: 70px; }
            
            .story-list-content {
                width: 100%;
                height: 100%;
                max-height: 100%;
                border-radius: 0;
            }
        }
        
        @media (max-width: 480px) {
            .storage-info {
                display: none; /* åœ¨éå¸¸å°çš„å±å¹•ä¸Šéšè—å­˜å‚¨ä¿¡æ¯ */
            }
            
            /* è¿›ä¸€æ­¥è°ƒæ•´æŒ‰é’®ä½ç½®ï¼Œç¡®ä¿ä¸ä¼šè¢«é®æŒ¡ */
            #toggleRoute, #recordStory { top: 70px; padding: 8px 12px; font-size: 0.8rem; }
            #storyListButton { top: 110px; padding: 8px 12px; font-size: 0.8rem; }
            #manageData { top: 150px; padding: 8px 12px; font-size: 0.8rem; }
            .sidebar-toggle { top: 70px; }
        }
        
        /* æ·»åŠ ç§»åŠ¨ç«¯ä¼˜åŒ– */
        input, textarea, button, select { font-size: 16px; } /* é˜²æ­¢iOSç¼©æ”¾ */
        .no-select { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        /* æ•…äº‹å¡ç‰‡è§¦æ‘¸ä¼˜åŒ– */
        .story-card { transition: transform 0.2s ease; }
        .story-card:active { transform: scale(0.98); }
        /* æµ®åŠ¨æ¶ˆæ¯æç¤º */
        .floating-message { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.85); color: white; padding: 15px 25px; border-radius: 12px; z-index: 3000; font-size: 1rem; text-align: center; max-width: 80%; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    </style>
</head>
<body class="no-select">
    <!-- å¯¼èˆªæ  -->
    <div id="navbar">
        <div class="nav-left">
            <button id="sidebarToggle" class="sidebar-toggle">ğŸ“–</button>
            <div class="logo">
                <h1>ğŸ—ºï¸ PathLife æ•…äº‹åœ°å›¾</h1>
                <p>è®°å½•æ—…ç¨‹ï¼Œä¸²è”æ¯ä¸ªæ•…äº‹ç¬é—´</p>
            </div>
        </div>
        
        <div class="nav-right">
            <!-- å­˜å‚¨ä¿¡æ¯æ˜¾ç¤ºåœ¨å¯¼èˆªæ  -->
            <div class="storage-info" id="storageInfo">
                <div class="storage-info-header">
                    <span>ğŸ“Š å­˜å‚¨çŠ¶æ€</span>
                    <span id="storagePercent">0%</span>
                </div>
                <progress id="storageProgress" value="0" max="100"></progress>
                <div class="storage-info-details">
                    <span>æ•…äº‹: <span id="storyCount">0</span></span>
                    <span>å·²ç”¨: <span id="storageUsed">0 KB</span></span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åœ°å›¾å®¹å™¨ - å æ»¡å‰©ä½™ç©ºé—´ -->
    <div id="mapContainer">
        <div id="mapLoading" class="map-loading"></div>
    </div>
    
    <!-- åœ°å›¾æ§åˆ¶æŒ‰é’® -->
    <button id="toggleRoute">ğŸ“ è·¯çº¿</button>
    <button id="recordStory">ğŸ“ è®°å½•</button>
    <button id="storyListButton">ğŸ“š æ•…äº‹åˆ—è¡¨</button>
    <button id="manageData">ğŸ’¾ æ•°æ®</button>
    <button id="locateButton">ğŸ“ æ›´æ–°ä½ç½®</button>
    
    <!-- ä¾§è¾¹æ  -->
    <div id="sidebar">
        <div class="sidebar-content">
            <!-- çŠ¶æ€æç¤ºæ¡† -->
            <div class="status-box success" id="keyStatus"></div>
            
            <!-- å½“å‰ä½ç½®ä¿¡æ¯ -->
            <div class="location-box">
                <div class="location-container">
                    <div id="currentLocationInfo">
                        <h3>ğŸ“ å½“å‰ä½ç½®ä¿¡æ¯</h3>
                        <p><strong>åœ°å€ï¼š</strong><span id="locationAddress">æ­£åœ¨è·å–ä½ç½®...</span></p>
                        <p><strong>åæ ‡ï¼š</strong><span id="locationCoords">-</span></p>
                        <p><strong>çŠ¶æ€ï¼š</strong><span id="locationStatus">å®šä½ä¸­...</span></p>
                    </div>
                </div>
            </div>
            
            <!-- æ•…äº‹åˆ—è¡¨ -->
            <div class="stories-list" id="storiesList"></div>
        </div>
    </div>
    
    <!-- æ•…äº‹åˆ—è¡¨æ¨¡æ€æ¡† -->
    <div id="storyListModal" class="story-list-modal">
        <div class="story-list-content">
            <div class="story-list-header">
                <h2>ğŸ“š æˆ‘çš„æ•…äº‹åˆ—è¡¨</h2>
                <p>æŒ‰æ—¥æœŸæŸ¥çœ‹æ‰€æœ‰æ•…äº‹è®°å½•</p>
                <button class="close-story-list" onclick="closeStoryList()">Ã—</button>
            </div>
            <div class="story-list-filters">
                <div class="search-box">
                    <input type="text" id="storySearch" placeholder="æœç´¢æ•…äº‹..." oninput="searchStories()">
                    <span>ğŸ”</span>
                </div>
                <div class="filter-options">
                    <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
                    <button class="filter-btn" data-filter="week">æœ¬å‘¨</button>
                    <button class="filter-btn" data-filter="month">æœ¬æœˆ</button>
                    <button class="filter-btn" data-filter="year">ä»Šå¹´</button>
                </div>
            </div>
            <div class="story-list-container" id="storyListContent">
                <!-- æ•…äº‹åˆ—è¡¨å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="story-list-footer">
                <div class="story-stats">
                    å…± <span id="totalStoriesCount">0</span> ä¸ªæ•…äº‹ï¼Œåˆ†å¸ƒåœ¨ <span id="totalDaysCount">0</span> å¤©
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç¼–è¾‘å™¨æ¨¡æ€æ¡† -->
    <div id="editorModal">
        <div class="editor-content">
            <div class="editor-header">
                <h2>âœï¸ ç¼–è¾‘æ•…äº‹</h2>
                <div class="location-info" id="editorLocation"></div>
            </div>
            <div class="editor-toolbar">
                <button onclick="formatText('bold')"><b>B</b></button>
                <button onclick="formatText('italic')"><i>I</i></button>
                <button onclick="formatText('insertUnorderedList')">ğŸ“‹ åˆ—è¡¨</button>
                <button onclick="showImageUpload()">ğŸ–¼ï¸ å›¾ç‰‡</button>
            </div>
            <div id="storyEditor" contenteditable="true" placeholder="å†™ä¸‹ä½ çš„æ•…äº‹..."></div>
            <div class="editor-footer">
                <button id="closeEditor">å–æ¶ˆ</button>
                <button id="saveStory">ä¿å­˜æ•…äº‹</button>
            </div>
        </div>
    </div>
    
    <!-- æ•°æ®ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="dataModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ’¾ æ•°æ®ç®¡ç†</h3>
            </div>
            <div class="modal-options">
                <div class="modal-option" onclick="exportData()">
                    <i>ğŸ“¤</i>
                    <span>å¯¼å‡ºæ•°æ®</span>
                    <p>å¤‡ä»½æ‰€æœ‰æ•…äº‹åˆ°æœ¬åœ°æ–‡ä»¶</p>
                </div>
                <div class="modal-option" onclick="importData()">
                    <i>ğŸ“¥</i>
                    <span>å¯¼å…¥æ•°æ®</span>
                    <p>ä»å¤‡ä»½æ–‡ä»¶æ¢å¤æ•…äº‹</p>
                </div>
                <div class="modal-option" onclick="clearData()">
                    <i>ğŸ—‘ï¸</i>
                    <span>æ¸…ç©ºæ•°æ®</span>
                    <p>åˆ é™¤æ‰€æœ‰æ•…äº‹è®°å½•</p>
                </div>
                <div class="modal-option" onclick="optimizeStorage()">
                    <i>âš™ï¸</i>
                    <span>ä¼˜åŒ–å­˜å‚¨</span>
                    <p>æ¸…ç†æ— æ•ˆæ•°æ®ï¼Œé‡Šæ”¾ç©ºé—´</p>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeDataModal()" style="background: #e74c3c; color: white;">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <!-- ç¡®è®¤å¯¹è¯æ¡† -->
    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-content">
            <h3 id="confirmTitle">ç¡®è®¤æ“ä½œ</h3>
            <div class="confirm-message" id="confirmMessage"></div>
            <div class="confirm-buttons">
                <button class="confirm-cancel" onclick="cancelConfirm()">å–æ¶ˆ</button>
                <button class="confirm-ok" onclick="executeConfirm()">ç¡®è®¤</button>
            </div>
        </div>
    </div>
    
    <!-- å›¾ç‰‡ä¸Šä¼ æ¨¡æ€æ¡† -->
    <div id="imageUploadModal" class="image-upload-modal">
        <div class="image-upload-content">
            <h3>ğŸ“¸ æ·»åŠ å›¾ç‰‡</h3>
            <div class="upload-options">
                <div class="upload-option" onclick="openCamera()">
                    <i>ğŸ“·</i>
                    <span>æ‹ç…§</span>
                    <p>ä½¿ç”¨æ‘„åƒå¤´æ‹æ‘„æ–°ç…§ç‰‡</p>
                </div>
                <div class="upload-option" onclick="openFilePicker()">
                    <i>ğŸ“</i>
                    <span>ä¸Šä¼ å›¾ç‰‡</span>
                    <p>ä»ç›¸å†Œæˆ–æ–‡ä»¶ä¸­é€‰æ‹©å›¾ç‰‡</p>
                </div>
                <img id="imagePreview" class="image-preview" alt="å›¾ç‰‡é¢„è§ˆ">
                <button class="close-upload" onclick="closeImageUpload()">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥å’Œç›¸æœºè¾“å…¥ -->
    <input type="file" id="cameraInput" accept="image/*" capture="environment">
    <input type="file" id="fileInput" accept="image/*">
    <input type="file" id="importFileInput" accept=".json" style="display: none;">

    <script>
        // é…ç½®
        const AMapKey = '0874b5c6096d30f6f75ae6949f5c4468';
        const STORAGE_KEY = 'pathLifeStories_v6'; // æ›´æ–°ç‰ˆæœ¬
        const MAX_STORAGE_SIZE = 5 * 1024 * 1024; // 5MB æœ€å¤§å­˜å‚¨é™åˆ¶
        const MAX_STORIES = 100; // æœ€å¤šä¿å­˜100ä¸ªæ•…äº‹
        
        // å…¨å±€å˜é‡
        let map = null;
        let markers = [];
        let currentPlace = null;
        let editingStoryId = null;
        let routeLine = null;
        let isRouteVisible = false;
        let stories = [];
        let mapInitialized = false;
        let geocoder = null;
        let currentPositionMarker = null;
        let pendingConfirmAction = null;
        let currentStoryFilter = 'all';
        let searchKeyword = '';
        let isSidebarOpen = false;

        // å­˜å‚¨ç®¡ç†ç±»
        const StorageManager = {
            // åŠ è½½æ•…äº‹æ•°æ®ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬æ•°æ®ï¼‰
            loadStories: function() {
                try {
                    const savedData = localStorage.getItem(STORAGE_KEY);
                    if (savedData) {
                        const parsed = JSON.parse(savedData);
                        // éªŒè¯æ•°æ®ç»“æ„
                        if (Array.isArray(parsed)) {
                            // æ•°æ®è¿ç§»ï¼šä¸ºæ—§æ•°æ®æ·»åŠ æ—¥æœŸå­—æ®µ
                            stories = parsed.map(story => {
                                const timestamp = story.timestamp || Date.now();
                                const date = story.date || new Date(timestamp).toISOString().split('T')[0];
                                const dateDisplay = story.dateDisplay || new Date(timestamp).toLocaleDateString('zh-CN', {
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric',
                                    weekday: 'long'
                                });
                                
                                return {
                                    id: story.id || 'story_' + Date.now(),
                                    title: story.title || 'æˆ‘çš„æ•…äº‹',
                                    placeName: story.placeName || 'å½“å‰ä½ç½®',
                                    lng: story.lng || 114.298572,
                                    lat: story.lat || 30.584355,
                                    address: story.address || 'æœªçŸ¥ä½ç½®',
                                    content: story.content || '',
                                    time: story.time || new Date(timestamp).toLocaleString(),
                                    timestamp: timestamp,
                                    date: date,
                                    dateDisplay: dateDisplay,
                                    version: story.version || 4
                                };
                            });
                            console.log(`åŠ è½½äº† ${stories.length} ä¸ªæ•…äº‹ï¼ŒæŒ‰æ—¥æœŸåˆ†ç»„`);
                            return stories;
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½æ•…äº‹æ•°æ®å¤±è´¥:', error);
                    this.showMessage('âš ï¸ æ•°æ®åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤æ•°æ®');
                }
                stories = [];
                return stories;
            },

            // ä¿å­˜æ•…äº‹æ•°æ®
            saveStories: function() {
                try {
                    // æ£€æŸ¥å­˜å‚¨å®¹é‡
                    const storageSize = this.getStorageSize();
                    if (storageSize > MAX_STORAGE_SIZE) {
                        this.showMessage('âš ï¸ å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œå°†åˆ é™¤æœ€æ—©çš„æ•…äº‹');
                        this.cleanupOldStories();
                    }
                    
                    // é™åˆ¶æ•…äº‹æ•°é‡
                    if (stories.length > MAX_STORIES) {
                        this.showMessage(`âš ï¸ å·²è¾¾åˆ°æœ€å¤§æ•…äº‹æ•°é‡(${MAX_STORIES})ï¼Œåˆ é™¤æœ€æ—©çš„æ•…äº‹`);
                        stories = stories.slice(-MAX_STORIES);
                    }
                    
                    // æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯
                    const dataToSave = stories.map(story => ({
                        ...story,
                        version: 6
                    }));
                    
                    const jsonString = JSON.stringify(dataToSave);
                    localStorage.setItem(STORAGE_KEY, jsonString);
                    
                    // æ›´æ–°å­˜å‚¨æ˜¾ç¤º
                    this.updateStorageDisplay();
                    
                    console.log(`ä¿å­˜äº† ${stories.length} ä¸ªæ•…äº‹`);
                    return true;
                } catch (error) {
                    console.error('ä¿å­˜æ•…äº‹æ•°æ®å¤±è´¥:', error);
                    this.showMessage('âŒ ä¿å­˜å¤±è´¥ï¼Œå­˜å‚¨ç©ºé—´å¯èƒ½ä¸è¶³');
                    return false;
                }
            },

            // è·å–å­˜å‚¨å¤§å°
            getStorageSize: function() {
                const data = localStorage.getItem(STORAGE_KEY);
                return data ? new Blob([data]).size : 0;
            },

            // æ›´æ–°å­˜å‚¨æ˜¾ç¤º
            updateStorageDisplay: function() {
                const storageSize = this.getStorageSize();
                const percent = Math.min(Math.round((storageSize / MAX_STORAGE_SIZE) * 100), 100);
                
                document.getElementById('storageProgress').value = percent;
                document.getElementById('storagePercent').textContent = percent + '%';
                document.getElementById('storageUsed').textContent = this.formatBytes(storageSize);
                document.getElementById('storyCount').textContent = stories.length;
                
                // æ›´æ–°çŠ¶æ€é¢œè‰²
                const storageInfo = document.getElementById('storageInfo');
                if (percent > 90) {
                    storageInfo.style.background = '#fff3cd';
                    storageInfo.style.borderColor = '#ffeaa7';
                } else if (percent > 70) {
                    storageInfo.style.background = '#e8f4fd';
                    storageInfo.style.borderColor = '#b6e0fe';
                } else {
                    storageInfo.style.background = '#f8f9fa';
                    storageInfo.style.borderColor = '#e9ecef';
                }
            },

            // æ ¼å¼åŒ–å­—èŠ‚å¤§å°
            formatBytes: function(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            },

            // æ¸…ç†æ—§æ•…äº‹
            cleanupOldStories: function() {
                if (stories.length > 0) {
                    // æŒ‰æ—¶é—´æ’åºï¼Œä¿ç•™æœ€æ–°çš„80%
                    stories.sort((a, b) => b.timestamp - a.timestamp);
                    const keepCount = Math.floor(stories.length * 0.8);
                    stories = stories.slice(0, keepCount);
                    this.saveStories();
                }
            },

            // ä¼˜åŒ–å­˜å‚¨ç©ºé—´
            optimizeStorage: function() {
                const originalCount = stories.length;
                
                // 1. åˆ é™¤å†…å®¹ä¸ºç©ºçš„æ•…äº‹
                stories = stories.filter(story => 
                    story.content && story.content.trim().length > 0
                );
                
                // 2. å‹ç¼©å›¾ç‰‡æ•°æ®ï¼ˆç§»é™¤è¿‡å¤§çš„base64å›¾ç‰‡ï¼‰
                stories = stories.map(story => {
                    if (story.content && story.content.includes('base64')) {
                        // æŸ¥æ‰¾å¹¶å‹ç¼©base64å›¾ç‰‡
                        const compressedContent = story.content.replace(
                            /<img[^>]+src="data:image[^"]+"[^>]*>/g, 
                            '<img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/2wBDAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/wAARCAABAAEDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECIwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECIwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEFSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD+/iiiigD/2Q==" style="max-width:100%;border-radius:8px;margin:10px 0;" alt="[å›¾ç‰‡å·²å‹ç¼©]">'
                        );
                        return { ...story, content: compressedContent };
                    }
                    return story;
                });
                
                // 3. ç§»é™¤é‡å¤çš„æ•…äº‹ï¼ˆåŸºäºå†…å®¹å’Œä½ç½®ï¼‰
                const seen = new Set();
                stories = stories.filter(story => {
                    const key = `${story.lng}_${story.lat}_${story.title}_${story.timestamp}`;
                    if (seen.has(key)) return false;
                    seen.add(key);
                    return true;
                });
                
                this.saveStories();
                
                const removedCount = originalCount - stories.length;
                if (removedCount > 0) {
                    this.showMessage(`âœ… ä¼˜åŒ–å®Œæˆï¼Œåˆ é™¤äº† ${removedCount} ä¸ªæ— æ•ˆæ•…äº‹`);
                } else {
                    this.showMessage('âœ… å­˜å‚¨å·²æ˜¯æœ€ä¼˜çŠ¶æ€');
                }
            },

            // å¯¼å‡ºæ•°æ®
            exportData: function() {
                try {
                    const data = {
                        version: 6,
                        exportDate: new Date().toISOString(),
                        totalStories: stories.length,
                        stories: stories
                    };
                    
                    const jsonString = JSON.stringify(data, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `PathLife_Backup_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    URL.revokeObjectURL(url);
                    
                    this.showMessage(`âœ… å·²å¯¼å‡º ${stories.length} ä¸ªæ•…äº‹`);
                    return true;
                } catch (error) {
                    console.error('å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
                    this.showMessage('âŒ å¯¼å‡ºå¤±è´¥');
                    return false;
                }
            },

            // å¯¼å…¥æ•°æ®
            importData: function() {
                document.getElementById('importFileInput').click();
            },

            // å¤„ç†å¯¼å…¥æ–‡ä»¶
            handleImportFile: function(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        let importedStories = [];
                        
                        if (Array.isArray(importedData)) {
                            // æ—§ç‰ˆæœ¬æ ¼å¼
                            importedStories = importedData;
                        } else if (importedData.stories && Array.isArray(importedData.stories)) {
                            // æ–°ç‰ˆæœ¬æ ¼å¼
                            importedStories = importedData.stories;
                        } else {
                            throw new Error('æ— æ•ˆçš„æ•°æ®æ ¼å¼');
                        }
                        
                        // éªŒè¯æ•°æ®å¹¶æ·»åŠ æ—¥æœŸå­—æ®µ
                        const validStories = importedStories.filter(story => 
                            story && story.id && story.title && story.lng && story.lat
                        ).map(story => {
                            const timestamp = story.timestamp || Date.now();
                            const date = story.date || new Date(timestamp).toISOString().split('T')[0];
                            const dateDisplay = story.dateDisplay || new Date(timestamp).toLocaleDateString('zh-CN', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                weekday: 'long'
                            });
                            
                            return {
                                ...story,
                                date: date,
                                dateDisplay: dateDisplay
                            };
                        });
                        
                        if (validStories.length === 0) {
                            throw new Error('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æ•…äº‹æ•°æ®');
                        }
                        
                        // åˆå¹¶æ•°æ®ï¼ˆé¿å…é‡å¤ï¼‰
                        const existingIds = new Set(stories.map(s => s.id));
                        const newStories = validStories.filter(story => !existingIds.has(story.id));
                        
                        if (newStories.length > 0) {
                            stories = [...stories, ...newStories];
                            this.saveStories();
                            this.showMessage(`âœ… å·²å¯¼å…¥ ${newStories.length} ä¸ªæ–°æ•…äº‹`);
                            renderStoryList();
                            loadStoriesOnMap();
                        } else {
                            this.showMessage('â„¹ï¸ æ²¡æœ‰å‘ç°æ–°çš„æ•…äº‹æ•°æ®');
                        }
                    } catch (error) {
                        console.error('å¯¼å…¥æ•°æ®å¤±è´¥:', error);
                        this.showMessage('âŒ å¯¼å…¥å¤±è´¥: ' + error.message);
                    }
                };
                reader.readAsText(file);
            },

            // æ¸…ç©ºæ‰€æœ‰æ•°æ®
            clearAllData: function() {
                pendingConfirmAction = () => {
                    const count = stories.length;
                    stories = [];
                    localStorage.removeItem(STORAGE_KEY);
                    this.updateStorageDisplay();
                    renderStoryList();
                    loadStoriesOnMap();
                    this.showMessage(`âœ… å·²åˆ é™¤ ${count} ä¸ªæ•…äº‹`);
                    closeDataModal();
                };
                showConfirm('æ¸…ç©ºæ‰€æœ‰æ•°æ®', 'ç¡®å®šè¦åˆ é™¤æ‰€æœ‰æ•…äº‹æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚');
            },

            // æ˜¾ç¤ºæ¶ˆæ¯
            showMessage: function(message, duration = 2000) {
                const msg = document.createElement('div');
                msg.className = 'floating-message';
                msg.textContent = message;
                document.body.appendChild(msg);
                setTimeout(() => msg.remove(), duration);
            }
        };

        // åˆå§‹åŒ–å­˜å‚¨
        stories = StorageManager.loadStories();

        // æ£€æŸ¥é«˜å¾·åœ°å›¾APIæ˜¯å¦åŠ è½½æˆåŠŸ
        function checkAMapLoaded() {
            if (typeof AMap === 'undefined') {
                document.getElementById('keyStatus').className = 'status-box error';
                return false;
            }
            return true;
        }

        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            if (!checkAMapLoaded()) {
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('mapLoading').style.display = 'flex';
            
            try {
                // ä»¥æ­¦æ±‰ä¸ºä¸­å¿ƒ (æ­¦æ±‰åæ ‡: 114.298572, 30.584355)
                map = new AMap.Map('mapContainer', {
                    zoom: 12,
                    center: [114.298572, 30.584355],
                    viewMode: '2D',
                    resizeEnable: true,
                    touchZoom: true,
                    dragEnable: true,
                    zoomEnable: true,
                    doubleClickZoom: true
                });
                
                console.log('åœ°å›¾åˆå§‹åŒ–æˆåŠŸ');
                
                // éšè—åŠ è½½çŠ¶æ€
                document.getElementById('mapLoading').style.display = 'none';
                
                // æ›´æ–°çŠ¶æ€
                document.getElementById('keyStatus').innerHTML = 'âœ… åœ°å›¾å·²åŠ è½½å®Œæˆ';
                document.getElementById('keyStatus').className = 'status-box success';
                
                mapInitialized = true;
                
                // åˆå§‹åŒ–åœ°ç†ç¼–ç æœåŠ¡
                geocoder = new AMap.Geocoder({
                    city: "å…¨å›½"
                });
                
                // åŠ è½½å·²æœ‰æ•…äº‹
                loadStoriesOnMap();
                renderStoryList();
                
                // è‡ªåŠ¨å®šä½
                autoLocate();
                
                // æ·»åŠ åœ°å›¾ç‚¹å‡»äº‹ä»¶
                map.on('click', function(e) {
                    const lng = e.lnglat.getLng();
                    const lat = e.lnglat.getLat();
                    updateCurrentPosition(lng, lat, true);
                });
                
            } catch (error) {
                console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
                document.getElementById('mapLoading').style.display = 'none';
                document.getElementById('keyStatus').className = 'status-box error';
            }
        }

        // åˆ‡æ¢ä¾§è¾¹æ 
        function toggleSidebar() {
            isSidebarOpen = !isSidebarOpen;
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebarToggle');
            
            if (isSidebarOpen) {
                sidebar.classList.add('sidebar-open');
                toggleBtn.textContent = 'ğŸ—ºï¸';
                toggleBtn.style.right = '350px';
            } else {
                sidebar.classList.remove('sidebar-open');
                toggleBtn.textContent = 'ğŸ“–';
                toggleBtn.style.right = '0';
            }
        }

        // è‡ªåŠ¨å®šä½
        function autoLocate() {
            updateLocationStatus('æ­£åœ¨è·å–æ‚¨çš„ä½ç½®...');
            
            // å…ˆå°è¯•ä½¿ç”¨æµè§ˆå™¨å®šä½
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lng = position.coords.longitude;
                        const lat = position.coords.latitude;
                        updateCurrentPosition(lng, lat, false);
                        updateLocationStatus('å®šä½æˆåŠŸï¼');
                    },
                    function(error) {
                        console.log('æµè§ˆå™¨å®šä½å¤±è´¥');
                        updateLocationStatus('ç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®æˆ–ä½¿ç”¨æ›´æ–°æŒ‰é’®');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                console.log('æµè§ˆå™¨ä¸æ”¯æŒå®šä½');
                updateLocationStatus('ç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®æˆ–ä½¿ç”¨æ›´æ–°æŒ‰é’®');
            }
        }

        // æ›´æ–°å½“å‰ä½ç½®
        function updateCurrentPosition(lng, lat, fromClick = false) {
            // æ¸…é™¤ä¹‹å‰çš„å½“å‰ä½ç½®æ ‡è®°
            if (currentPositionMarker) {
                map.remove(currentPositionMarker);
            }
            
            // æ·»åŠ æ–°çš„å½“å‰ä½ç½®æ ‡è®°
            currentPositionMarker = new AMap.Marker({
                position: [lng, lat],
                map: map,
                title: 'å½“å‰ä½ç½®',
                content: '<div style="background:#e74c3c;color:white;border-radius:50%;width:24px;height:24px;text-align:center;line-height:24px;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);">ğŸ“</div>',
                offset: new AMap.Pixel(-12, -12),
                animation: "AMAP_ANIMATION_DROP"
            });
            
            // å¦‚æœæ˜¯ä»åœ°å›¾ç‚¹å‡»çš„ï¼Œå®šä½åˆ°è¯¥ä½ç½®
            if (fromClick) {
                map.setCenter([lng, lat]);
                map.setZoom(16);
                updateLocationStatus('å·²é€‰æ‹©æ–°ä½ç½®');
            } else {
                map.setCenter([lng, lat]);
                map.setZoom(15);
            }
            
            // æ›´æ–°åæ ‡æ˜¾ç¤º
            document.getElementById('locationCoords').textContent = 
                lng.toFixed(6) + ', ' + lat.toFixed(6);
            
            // è·å–åœ°å€ä¿¡æ¯
            getAddressFromCoords(lng, lat);
            
            // å­˜å‚¨å½“å‰ä½ç½®ä¿¡æ¯
            currentPlace = {
                location: { lng, lat }
            };
        }

        // æ ¹æ®åæ ‡è·å–åœ°å€
        function getAddressFromCoords(lng, lat) {
            if (!geocoder) return;
            
            geocoder.getAddress([lng, lat], function(status, result) {
                if (status === 'complete' && result.info === 'OK') {
                    const address = result.regeocode.formattedAddress;
                    document.getElementById('locationAddress').textContent = address;
                    
                    // æ›´æ–°å½“å‰ä½ç½®ä¿¡æ¯
                    if (currentPlace) {
                        currentPlace.address = address;
                    }
                } else {
                    document.getElementById('locationAddress').textContent = 'æ— æ³•è·å–è¯¦ç»†åœ°å€';
                    if (currentPlace) {
                        currentPlace.address = 'åæ ‡: ' + lng.toFixed(6) + ', ' + lat.toFixed(6);
                    }
                }
            });
        }

        // æ›´æ–°å®šä½çŠ¶æ€
        function updateLocationStatus(message) {
            document.getElementById('locationStatus').textContent = message;
        }

        // æ‰“å¼€ç¼–è¾‘å™¨
        function openEditor(place, storyId = null) {
            if (!place) {
                StorageManager.showMessage('è¯·å…ˆè·å–ä½ç½®ä¿¡æ¯');
                return;
            }
            
            editingStoryId = storyId;
            
            // è®¾ç½®ç¼–è¾‘å™¨ä½ç½®ä¿¡æ¯åŒºåŸŸ
            const editorLocation = document.getElementById('editorLocation');
            editorLocation.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <label for="placeNameInput" style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">
                        åœ°ç‚¹åç§°ï¼š
                    </label>
                    <input type="text" id="placeNameInput" 
                           placeholder="ä¸ºè¿™ä¸ªåœ°ç‚¹èµ·ä¸ªåå­—ï¼ˆå¦‚ï¼šæˆ‘çš„ç§˜å¯†åŸºåœ°ï¼‰" 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95rem;">
                </div>
                <div>
                    <strong>è¯¦ç»†åœ°å€ï¼š</strong><br>
                    <small id="editorAddressDetail"></small>
                </div>
            `;
            
            const addressDetail = document.getElementById('editorAddressDetail');
            
            // è®¾ç½®é»˜è®¤åœ°ç‚¹åç§°å’Œè¯¦ç»†åœ°å€
            if (storyId) {
                const story = stories.find(s => s.id === storyId);
                document.getElementById('placeNameInput').value = story?.placeName || 'æˆ‘çš„åœ°ç‚¹';
                addressDetail.textContent = story?.address || 
                    `åæ ‡: ${place.location.lng.toFixed(6)}, ${place.location.lat.toFixed(6)}`;
            } else {
                // æ–°æ•…äº‹ï¼šä½¿ç”¨è‡ªåŠ¨è·å–çš„åœ°å€ä½œä¸ºé»˜è®¤åœ°ç‚¹åç§°
                document.getElementById('placeNameInput').value = '';
                addressDetail.textContent = place.address || 
                    `åæ ‡: ${place.location.lng.toFixed(6)}, ${place.location.lat.toFixed(6)}`;
            }
            
            // è®¾ç½®ç¼–è¾‘å™¨å†…å®¹
            const editor = document.getElementById('storyEditor');
            if (storyId) {
                const story = stories.find(s => s.id === storyId);
                editor.innerHTML = story?.content || '';
            } else {
                editor.innerHTML = '<p>åœ¨æ­¤å†™ä¸‹ä½ çš„æ•…äº‹...</p>';
            }
            
            document.getElementById('editorModal').style.display = 'block';
            setTimeout(() => {
                document.getElementById('placeNameInput').focus();
            }, 100);
        }

        // ä¿å­˜æ•…äº‹
        function saveStory() {
            if (!currentPlace) return;
            
            const editor = document.getElementById('storyEditor');
            const content = editor.innerHTML.trim();
            const textContent = editor.innerText.trim();
            
            // è·å–ç”¨æˆ·è¾“å…¥çš„åœ°ç‚¹åç§°
            const placeNameInput = document.getElementById('placeNameInput');
            const placeName = placeNameInput.value.trim() || 'æˆ‘çš„åœ°ç‚¹';
            
            if (!textContent || textContent === 'åœ¨æ­¤å†™ä¸‹ä½ çš„æ•…äº‹...') {
                StorageManager.showMessage('è¯·è¾“å…¥æ•…äº‹å†…å®¹');
                return;
            }
            
            const storyData = {
                id: editingStoryId || 'story_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                title: textContent.substring(0, 30) || 'æˆ‘çš„æ•…äº‹',
                placeName: placeName, // ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„åœ°ç‚¹åç§°
                lng: currentPlace.location.lng,
                lat: currentPlace.location.lat,
                address: currentPlace.address || `åæ ‡: ${currentPlace.location.lng.toFixed(6)}, ${currentPlace.location.lat.toFixed(6)}`,
                content: content,
                time: new Date().toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                timestamp: Date.now(),
                // æ·»åŠ æ—¥æœŸåˆ†ç»„å­—æ®µ
                date: new Date().toISOString().split('T')[0], // æ ¼å¼: YYYY-MM-DD
                dateDisplay: new Date().toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                }),
                version: 6
            };
            
            // æ›´æ–°æˆ–æ·»åŠ æ•…äº‹
            const index = stories.findIndex(s => s.id === storyData.id);
            if (index > -1) {
                stories[index] = storyData;
            } else {
                stories.push(storyData);
            }
            
            // æŒ‰æ—¶é—´æ’åº
            stories.sort((a, b) => b.timestamp - a.timestamp);
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            if (StorageManager.saveStories()) {
                // æ›´æ–°ç•Œé¢
                loadStoriesOnMap();
                renderStoryList();
                closeEditor();
                StorageManager.showMessage('âœ… æ•…äº‹å·²ä¿å­˜ï¼');
            }
        }

        // åœ¨åœ°å›¾ä¸ŠåŠ è½½æ•…äº‹æ ‡è®°
        function loadStoriesOnMap() {
            if (!map) return;
            
            // æ¸…é™¤æ—§çš„æ•…äº‹æ ‡è®°ï¼ˆä¿ç•™å½“å‰ä½ç½®æ ‡è®°ï¼‰
            markers.forEach(marker => {
                if (marker !== currentPositionMarker) {
                    map.remove(marker);
                }
            });
            markers = currentPositionMarker ? [currentPositionMarker] : [];
            
            stories.forEach(story => {
                const marker = new AMap.Marker({
                    position: [story.lng, story.lat],
                    map: map,
                    title: story.placeName,
                    content: '<div style="background:#27ae60;color:white;border-radius:50%;width:20px;height:20px;text-align:center;line-height:20px;">ğŸ“–</div>',
                    offset: new AMap.Pixel(-10, -10)
                });
                
                marker.on('click', () => {
                    highlightStoryCard(story.id);
                    const infoWindow = new AMap.InfoWindow({
                        content: `
                            <div style="padding:10px;max-width:250px;">
                                <h4 style="margin:0 0 5px 0;">${story.placeName}</h4>
                                <p style="color:#666;font-size:12px;margin:0 0 8px 0;">${story.time}</p>
                                <div style="font-size:13px;line-height:1.4;max-height:80px;overflow:hidden;">
                                    ${story.content.replace(/<[^>]+>/g, '').substring(0, 80)}...
                                </div>
                                <div style="margin-top:10px;display:flex;gap:5px;">
                                    <button onclick="editStory('${story.id}')" style="background:#3498db;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;font-size:12px;">ç¼–è¾‘</button>
                                    <button onclick="deleteStory('${story.id}')" style="background:#e74c3c;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;font-size:12px;">åˆ é™¤</button>
                                </div>
                            </div>
                        `
                    });
                    infoWindow.open(map, [story.lng, story.lat]);
                });
                
                markers.push(marker);
            });
            
            updateRouteLine();
        }

        // æ¸²æŸ“æ•…äº‹åˆ—è¡¨ï¼ˆä¾§è¾¹æ ï¼‰
        function renderStoryList() {
            const container = document.getElementById('storiesList');
            
            if (stories.length === 0) {
                container.innerHTML = `
                    <div class="empty-date-group">
                        <p>è¿˜æ²¡æœ‰æ•…äº‹è®°å½•</p>
                        <p>ç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®ï¼Œç„¶åç‚¹å‡»"è®°å½•"æŒ‰é’®å¼€å§‹è®°å½•</p>
                    </div>
                `;
                return;
            }
            
            // æŒ‰æ—¥æœŸåˆ†ç»„
            const groupedStories = groupStoriesByDate(stories);
            
            // ç”ŸæˆHTML
            let html = '';
            
            Object.keys(groupedStories).sort().reverse().forEach(date => {
                const storiesForDate = groupedStories[date];
                const dateObj = new Date(date);
                const today = new Date().toISOString().split('T')[0];
                const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
                
                // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
                let dateDisplay = date;
                if (date === today) {
                    dateDisplay = 'ä»Šå¤©';
                } else if (date === yesterday) {
                    dateDisplay = 'æ˜¨å¤©';
                } else {
                    dateDisplay = dateObj.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        weekday: 'long'
                    });
                }
                
                html += `
                    <div class="date-group">
                        <div class="date-header">
                            ${dateDisplay}
                            <span class="date-count">${storiesForDate.length}ä¸ªæ•…äº‹</span>
                            <div class="date-label">${date}</div>
                        </div>
                        <div class="story-group">
                            ${storiesForDate.map(story => `
                                <div class="story-card" data-id="${story.id}" onclick="focusOnStory('${story.id}')">
                                    <div class="story-header">
                                        <div class="story-title">${story.title}</div>
                                        <div class="story-time">${story.time.split(' ')[1]}</div>
                                    </div>
                                    <div class="story-location">ğŸ“ ${story.placeName}</div>
                                    <div class="story-preview">${story.content.replace(/<[^>]+>/g, '').substring(0, 80)}...</div>
                                    <div style="display:flex;gap:8px;margin-top:10px;">
                                        <button onclick="editStory('${story.id}'); event.stopPropagation();" style="flex:1;background:#3498db;color:white;border:none;padding:6px;border-radius:6px;font-size:0.8rem;">ç¼–è¾‘</button>
                                        <button onclick="deleteStory('${story.id}'); event.stopPropagation();" style="flex:1;background:#e74c3c;color:white;border:none;padding:6px;border-radius:6px;font-size:0.8rem;">åˆ é™¤</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // æŒ‰æ—¥æœŸåˆ†ç»„æ•…äº‹
        function groupStoriesByDate(stories) {
            const grouped = {};
            
            // æŒ‰æ—¶é—´æˆ³æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
            const sortedStories = [...stories].sort((a, b) => b.timestamp - a.timestamp);
            
            sortedStories.forEach(story => {
                // ä½¿ç”¨å·²æœ‰çš„dateå­—æ®µï¼Œå¦‚æœæ²¡æœ‰åˆ™ä»timestampç”Ÿæˆ
                const date = story.date || new Date(story.timestamp).toISOString().split('T')[0];
                
                if (!grouped[date]) {
                    grouped[date] = [];
                }
                grouped[date].push(story);
            });
            
            return grouped;
        }

        // æ‰“å¼€æ•…äº‹åˆ—è¡¨æ¨¡æ€æ¡†
        function openStoryList() {
            document.getElementById('storyListModal').style.display = 'block';
            renderStoryListModal();
            document.getElementById('storySearch').focus();
        }

        // å…³é—­æ•…äº‹åˆ—è¡¨æ¨¡æ€æ¡†
        function closeStoryList() {
            document.getElementById('storyListModal').style.display = 'none';
            // é‡ç½®æœç´¢å’Œç­›é€‰
            document.getElementById('storySearch').value = '';
            searchKeyword = '';
            currentStoryFilter = 'all';
            updateFilterButtons();
        }

        // æ¸²æŸ“æ•…äº‹åˆ—è¡¨æ¨¡æ€æ¡†
        function renderStoryListModal() {
            const container = document.getElementById('storyListContent');
            
            if (stories.length === 0) {
                container.innerHTML = `
                    <div class="story-list-empty">
                        <div class="story-list-empty-icon">ğŸ“š</div>
                        <h3>è¿˜æ²¡æœ‰æ•…äº‹è®°å½•</h3>
                        <p>å¼€å§‹è®°å½•ä½ çš„æ—…ç¨‹æ•…äº‹ï¼Œè®©å›å¿†æœ‰è¿¹å¯å¾ª</p>
                        <button onclick="closeStoryList(); recordStory();" style="background:#9b59b6;color:white;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:600;">
                            å¼€å§‹è®°å½•ç¬¬ä¸€ä¸ªæ•…äº‹
                        </button>
                    </div>
                `;
                updateStoryStats();
                return;
            }
            
            // ç­›é€‰æ•…äº‹
            let filteredStories = filterStories(stories, currentStoryFilter, searchKeyword);
            
            // æŒ‰æ—¥æœŸåˆ†ç»„
            const groupedStories = groupStoriesByDate(filteredStories);
            
            if (Object.keys(groupedStories).length === 0) {
                container.innerHTML = `
                    <div class="story-list-empty">
                        <div class="story-list-empty-icon">ğŸ”</div>
                        <h3>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ•…äº‹</h3>
                        <p>å°è¯•è°ƒæ•´æœç´¢å…³é”®è¯æˆ–ç­›é€‰æ¡ä»¶</p>
                        <button onclick="resetFilters()" style="background:#9b59b6;color:white;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:600;">
                            æ˜¾ç¤ºæ‰€æœ‰æ•…äº‹
                        </button>
                    </div>
                `;
                updateStoryStats();
                return;
            }
            
            // ç”ŸæˆHTML
            let html = '';
            
            Object.keys(groupedStories).sort().reverse().forEach(date => {
                const storiesForDate = groupedStories[date];
                const dateObj = new Date(date);
                const today = new Date().toISOString().split('T')[0];
                const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
                
                // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
                let dateDisplay = '';
                let dateSubtitle = date;
                
                if (date === today) {
                    dateDisplay = 'ä»Šå¤©';
                } else if (date === yesterday) {
                    dateDisplay = 'æ˜¨å¤©';
                } else {
                    dateDisplay = dateObj.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        weekday: 'long'
                    });
                    dateSubtitle = dateObj.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                }
                
                html += `
                    <div class="story-list-date-group">
                        <div class="story-list-date-header">
                            <div class="story-list-date-title">${dateDisplay}</div>
                            <div class="story-list-date-subtitle">
                                <span>${dateSubtitle}</span>
                                <span class="story-list-date-count">${storiesForDate.length}ä¸ªæ•…äº‹</span>
                            </div>
                        </div>
                        ${storiesForDate.map(story => `
                            <div class="story-list-story" onclick="focusOnStoryFromList('${story.id}')">
                                <div class="story-list-story-header">
                                    <div class="story-list-story-title">${story.title}</div>
                                    <div class="story-list-story-time">${story.time.split(' ')[1]}</div>
                                </div>
                                <div class="story-list-story-location">ğŸ“ ${story.placeName}</div>
                                <div class="story-list-story-preview">${story.content.replace(/<[^>]+>/g, '').substring(0, 100)}...</div>
                                <div class="story-list-story-actions">
                                    <button class="story-list-story-action-btn edit" onclick="editStoryFromList('${story.id}'); event.stopPropagation();">ç¼–è¾‘</button>
                                    <button class="story-list-story-action-btn delete" onclick="deleteStoryFromList('${story.id}'); event.stopPropagation();">åˆ é™¤</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            });
            
            container.innerHTML = html;
            updateStoryStats(filteredStories, Object.keys(groupedStories).length);
        }

        // ç­›é€‰æ•…äº‹
        function filterStories(stories, filter, keyword) {
            let filtered = stories;
            
            // åº”ç”¨æ—¶é—´ç­›é€‰
            const now = new Date();
            const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const oneMonthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
            const oneYearAgo = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
            
            if (filter === 'week') {
                filtered = filtered.filter(story => {
                    const storyDate = new Date(story.timestamp);
                    return storyDate >= oneWeekAgo;
                });
            } else if (filter === 'month') {
                filtered = filtered.filter(story => {
                    const storyDate = new Date(story.timestamp);
                    return storyDate >= oneMonthAgo;
                });
            } else if (filter === 'year') {
                filtered = filtered.filter(story => {
                    const storyDate = new Date(story.timestamp);
                    return storyDate >= oneYearAgo;
                });
            }
            
            // åº”ç”¨æœç´¢ç­›é€‰
            if (keyword && keyword.trim() !== '') {
                const searchTerm = keyword.trim().toLowerCase();
                filtered = filtered.filter(story => 
                    story.title.toLowerCase().includes(searchTerm) ||
                    story.placeName.toLowerCase().includes(searchTerm) ||
                    story.content.toLowerCase().includes(searchTerm) ||
                    story.address.toLowerCase().includes(searchTerm)
                );
            }
            
            return filtered;
        }

        // æœç´¢æ•…äº‹
        function searchStories() {
            searchKeyword = document.getElementById('storySearch').value;
            renderStoryListModal();
        }

        // é‡ç½®ç­›é€‰
        function resetFilters() {
            document.getElementById('storySearch').value = '';
            searchKeyword = '';
            currentStoryFilter = 'all';
            updateFilterButtons();
            renderStoryListModal();
        }

        // æ›´æ–°ç­›é€‰æŒ‰é’®çŠ¶æ€
        function updateFilterButtons() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.filter === currentStoryFilter) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // è®¾ç½®ç­›é€‰
        function setStoryFilter(filter) {
            currentStoryFilter = filter;
            updateFilterButtons();
            renderStoryListModal();
        }

        // æ›´æ–°æ•…äº‹ç»Ÿè®¡
        function updateStoryStats(filteredStories = stories, dayCount = null) {
            const totalStories = stories.length;
            const filteredCount = filteredStories.length;
            const totalDays = new Set(stories.map(s => s.date)).size;
            const filteredDays = dayCount || new Set(filteredStories.map(s => s.date)).size;
            
            document.getElementById('totalStoriesCount').textContent = filteredCount;
            document.getElementById('totalDaysCount').textContent = filteredDays;
            
            // å¦‚æœæ­£åœ¨ç­›é€‰ï¼Œæ˜¾ç¤ºç­›é€‰åçš„æ•°é‡
            if (filteredCount !== totalStories || currentStoryFilter !== 'all' || searchKeyword) {
                document.getElementById('totalStoriesCount').textContent = `${filteredCount}/${totalStories}`;
            }
        }

        // ä»æ•…äº‹åˆ—è¡¨èšç„¦åˆ°æ•…äº‹
        function focusOnStoryFromList(storyId) {
            const story = stories.find(s => s.id === storyId);
            if (story && map) {
                map.setCenter([story.lng, story.lat]);
                map.setZoom(16);
                closeStoryList();
                highlightStoryCard(storyId);
                StorageManager.showMessage(`ğŸ“ å·²å®šä½åˆ°: ${story.placeName}`);
            }
        }

        // ä»æ•…äº‹åˆ—è¡¨ç¼–è¾‘æ•…äº‹
        function editStoryFromList(storyId) {
            const story = stories.find(s => s.id === storyId);
            if (!story) return;
            
            currentPlace = {
                location: { lng: story.lng, lat: story.lat },
                address: story.address
            };
            
            closeStoryList();
            openEditor(currentPlace, storyId);
        }

        // ä»æ•…äº‹åˆ—è¡¨åˆ é™¤æ•…äº‹
        function deleteStoryFromList(storyId) {
            pendingConfirmAction = () => {
                const story = stories.find(s => s.id === storyId);
                if (story) {
                    stories = stories.filter(s => s.id !== storyId);
                    StorageManager.saveStories();
                    loadStoriesOnMap();
                    renderStoryList();
                    renderStoryListModal(); // æ›´æ–°æ¨¡æ€æ¡†ä¸­çš„åˆ—è¡¨
                    StorageManager.showMessage(`âœ… å·²åˆ é™¤æ•…äº‹: ${story.title}`);
                }
            };
            showConfirm('åˆ é™¤æ•…äº‹', 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ•…äº‹å—ï¼Ÿ');
        }

        // åˆ é™¤å•ä¸ªæ•…äº‹
        function deleteStory(storyId) {
            pendingConfirmAction = () => {
                const story = stories.find(s => s.id === storyId);
                if (story) {
                    stories = stories.filter(s => s.id !== storyId);
                    StorageManager.saveStories();
                    loadStoriesOnMap();
                    renderStoryList();
                    StorageManager.showMessage(`âœ… å·²åˆ é™¤æ•…äº‹: ${story.title}`);
                }
            };
            showConfirm('åˆ é™¤æ•…äº‹', 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ•…äº‹å—ï¼Ÿ');
        }

        // èšç„¦åˆ°æ•…äº‹åœ°ç‚¹
        function focusOnStory(storyId) {
            const story = stories.find(s => s.id === storyId);
            if (story && map) {
                map.setCenter([story.lng, story.lat]);
                map.setZoom(16);
                highlightStoryCard(storyId);
            }
        }

        // é«˜äº®æ•…äº‹å¡ç‰‡
        function highlightStoryCard(storyId) {
            document.querySelectorAll('.story-card').forEach(card => {
                card.classList.remove('active');
            });
            const card = document.querySelector(`.story-card[data-id="${storyId}"]`);
            if (card) card.classList.add('active');
        }

        // ç¼–è¾‘æ•…äº‹
        function editStory(storyId) {
            const story = stories.find(s => s.id === storyId);
            if (!story) return;
            
            currentPlace = {
                location: { lng: story.lng, lat: story.lat },
                address: story.address
            };
            
            openEditor(currentPlace, storyId);
        }

        // æ›´æ–°è·¯çº¿è¿çº¿
        function updateRouteLine() {
            if (!map) return;
            
            if (routeLine) {
                map.remove(routeLine);
                routeLine = null;
            }
            
            if (stories.length < 2 || !isRouteVisible) return;
            
            const sortedStories = [...stories].sort((a, b) => a.timestamp - b.timestamp);
            const linePath = sortedStories.map(s => [s.lng, s.lat]);
            
            routeLine = new AMap.Polyline({
                path: linePath,
                strokeColor: "#3498db",
                strokeOpacity: 0.8,
                strokeWeight: 4,
                strokeStyle: "solid"
            });
            
            map.add(routeLine);
            map.setFitView();
        }

        // åˆ‡æ¢è·¯çº¿æ˜¾ç¤º
        function toggleRoute() {
            isRouteVisible = !isRouteVisible;
            document.getElementById('toggleRoute').textContent = 
                isRouteVisible ? 'ğŸ“ éšè—è·¯çº¿' : 'ğŸ“ æ˜¾ç¤ºè·¯çº¿';
            updateRouteLine();
        }

        // æ‰“å¼€æ•°æ®ç®¡ç†æ¨¡æ€æ¡†
        function openDataModal() {
            document.getElementById('dataModal').style.display = 'block';
        }

        // å…³é—­æ•°æ®ç®¡ç†æ¨¡æ€æ¡†
        function closeDataModal() {
            document.getElementById('dataModal').style.display = 'none';
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            StorageManager.exportData();
            closeDataModal();
        }

        // å¯¼å…¥æ•°æ®
        function importData() {
            StorageManager.importData();
            closeDataModal();
        }

        // æ¸…ç©ºæ•°æ®
        function clearData() {
            StorageManager.clearAllData();
        }

        // ä¼˜åŒ–å­˜å‚¨
        function optimizeStorage() {
            StorageManager.optimizeStorage();
            closeDataModal();
        }

        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        function showConfirm(title, message) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').style.display = 'block';
        }

        // å–æ¶ˆç¡®è®¤
        function cancelConfirm() {
            document.getElementById('confirmModal').style.display = 'none';
            pendingConfirmAction = null;
        }

        // æ‰§è¡Œç¡®è®¤æ“ä½œ
        function executeConfirm() {
            document.getElementById('confirmModal').style.display = 'none';
            if (pendingConfirmAction) {
                pendingConfirmAction();
                pendingConfirmAction = null;
            }
        }

        // ç¼–è¾‘å™¨åŠŸèƒ½
        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('storyEditor').focus();
        }
        
        // æ˜¾ç¤ºå›¾ç‰‡ä¸Šä¼ é€‰é¡¹
        function showImageUpload() {
            document.getElementById('imageUploadModal').style.display = 'block';
        }
        
        // å…³é—­å›¾ç‰‡ä¸Šä¼ 
        function closeImageUpload() {
            document.getElementById('imageUploadModal').style.display = 'none';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imagePreview').src = '';
        }
        
        // æ‰“å¼€ç›¸æœº
        function openCamera() {
            document.getElementById('cameraInput').click();
        }
        
        // æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨
        function openFilePicker() {
            document.getElementById('fileInput').click();
        }
        
        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        function handleImageUpload(file) {
            if (!file.type.startsWith('image/')) {
                StorageManager.showMessage('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            // æ£€æŸ¥å›¾ç‰‡å¤§å°ï¼ˆé™åˆ¶ä¸º1MBï¼‰
            if (file.size > 1024 * 1024) {
                StorageManager.showMessage('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡1MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const imgData = e.target.result;
                
                // æ˜¾ç¤ºé¢„è§ˆ
                const preview = document.getElementById('imagePreview');
                preview.src = imgData;
                preview.style.display = 'block';
                
                // æ’å…¥åˆ°ç¼–è¾‘å™¨
                setTimeout(() => {
                    insertImageToEditor(imgData);
                    closeImageUpload();
                }, 1000);
            };
            reader.readAsDataURL(file);
        }
        
        // å°†å›¾ç‰‡æ’å…¥åˆ°ç¼–è¾‘å™¨
        function insertImageToEditor(imgData) {
            const editor = document.getElementById('storyEditor');
            const img = `<img src="${imgData}" style="max-width:100%;border-radius:8px;margin:10px 0;" alt="æ•…äº‹å›¾ç‰‡">`;
            document.execCommand('insertHTML', false, img);
            editor.focus();
        }

        // å…³é—­ç¼–è¾‘å™¨
        function closeEditor() {
            document.getElementById('editorModal').style.display = 'none';
            document.getElementById('storyEditor').innerHTML = '';
            editingStoryId = null;
        }

        // è®°å½•æ•…äº‹æŒ‰é’®ç‚¹å‡»
        function recordStory() {
            if (!currentPlace) {
                StorageManager.showMessage('è¯·å…ˆè·å–ä½ç½®ä¿¡æ¯');
                return;
            }
            openEditor(currentPlace);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–åœ°å›¾...');
            
            // æ£€æŸ¥APIæ˜¯å¦åŠ è½½æˆåŠŸ
            if (!checkAMapLoaded()) {
                // å¦‚æœAPIæœªåŠ è½½ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´å†æ£€æŸ¥
                setTimeout(() => {
                    if (!checkAMapLoaded()) {
                        document.getElementById('keyStatus').innerHTML = 'âŒ åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                        document.getElementById('keyStatus').className = 'status-box error';
                    } else {
                        initMap();
                    }
                }, 2000);
            } else {
                // APIå·²åŠ è½½ï¼Œåˆå§‹åŒ–åœ°å›¾
                initMap();
            }
            
            // åˆå§‹åŒ–å­˜å‚¨æ˜¾ç¤º
            StorageManager.updateStorageDisplay();
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
            document.getElementById('locateButton').addEventListener('click', autoLocate);
            document.getElementById('saveStory').addEventListener('click', saveStory);
            document.getElementById('closeEditor').addEventListener('click', closeEditor);
            document.getElementById('toggleRoute').addEventListener('click', toggleRoute);
            document.getElementById('recordStory').addEventListener('click', recordStory);
            document.getElementById('storyListButton').addEventListener('click', openStoryList);
            document.getElementById('manageData').addEventListener('click', openDataModal);
            
            // ç»‘å®šç­›é€‰æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => setStoryFilter(btn.dataset.filter));
            });
            
            // å›¾ç‰‡ä¸Šä¼ äº‹ä»¶
            document.getElementById('cameraInput').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    handleImageUpload(e.target.files[0]);
                }
            });
            
            document.getElementById('fileInput').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    handleImageUpload(e.target.files[0]);
                }
            });
            
            // å¯¼å…¥æ–‡ä»¶äº‹ä»¶
            document.getElementById('importFileInput').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    StorageManager.handleImportFile(e.target.files[0]);
                }
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            document.getElementById('editorModal').addEventListener('click', function(e) {
                if (e.target === this) closeEditor();
            });
            
            document.getElementById('storyListModal').addEventListener('click', function(e) {
                if (e.target === this) closeStoryList();
            });
            
            document.getElementById('imageUploadModal').addEventListener('click', function(e) {
                if (e.target === this) closeImageUpload();
            });
            
            document.getElementById('dataModal').addEventListener('click', function(e) {
                if (e.target === this) closeDataModal();
            });
            
            document.getElementById('confirmModal').addEventListener('click', function(e) {
                if (e.target === this) cancelConfirm();
            });
            
            // é€‚é…ç§»åŠ¨ç«¯é”®ç›˜å¼¹å‡º
            window.addEventListener('resize', function() {
                if (document.activeElement.tagName === 'TEXTAREA' || 
                    document.activeElement.tagName === 'INPUT') {
                    setTimeout(() => {
                        document.activeElement.scrollIntoView({behavior: 'smooth', block: 'center'});
                    }, 300);
                }
            });
            
            // å®šæœŸæ£€æŸ¥å­˜å‚¨çŠ¶æ€
            setInterval(() => StorageManager.updateStorageDisplay(), 30000);
        };
    </script>
</body>
</html>
