<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PathLife - æ•…äº‹åœ°å›¾</title>
    <!-- å¼•å…¥é«˜å¾·åœ°å›¾JS API -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=0874b5c6096d30f6f75ae6949f5c4468"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Helvetica Neue', 'Segoe UI', 'Microsoft YaHei', sans-serif; }
        html, body { height: 100%; width: 100%; overflow: hidden; touch-action: manipulation; }
        body { display: flex; flex-direction: column; background: #f5f7fa; color: #333; }
        #mapContainer { flex: 1; width: 100%; min-height: 0; position: relative; }
        #sidebar { width: 100%; background: white; display: flex; flex-direction: column; height: 40vh; border-top: 1px solid #e1e5eb; }
        .sidebar-toggle { display: none; position: absolute; bottom: 20px; right: 20px; z-index: 10; background: white; border: none; padding: 12px; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-size: 1.2rem; }
        .logo { padding: 15px; border-bottom: 1px solid #e1e5eb; flex-shrink: 0; }
        .logo h1 { font-size: 1.3rem; color: #2c3e50; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .logo p { color: #7f8c8d; font-size: 0.85rem; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .location-box { padding: 15px; border-bottom: 1px solid #e1e5eb; flex-shrink: 0; }
        .location-container { display: flex; flex-direction: column; gap: 8px; }
        #currentLocationInfo { background: #f8f9fa; border: 1px solid #e1e5eb; border-radius: 8px; padding: 12px; font-size: 0.85rem; line-height: 1.4; }
        #currentLocationInfo h3 { color: #2c3e50; margin-bottom: 6px; font-size: 0.95rem; }
        #currentLocationInfo p { color: #666; margin: 3px 0; font-size: 0.8rem; }
        #locateButton { background: #3498db; color: white; border: none; border-radius: 8px; padding: 10px 15px; cursor: pointer; font-weight: 600; font-size: 0.9rem; width: 100%; }
        .stories-list { flex: 1; overflow-y: auto; padding: 15px; -webkit-overflow-scrolling: touch; }
        .story-card { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 10px; padding: 12px; margin-bottom: 12px; cursor: pointer; }
        .story-card.active { border-color: #3498db; background: #e3f2fd; }
        .story-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .story-title { font-weight: 600; color: #2c3e50; font-size: 0.95rem; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .story-time { color: #95a5a6; font-size: 0.75rem; flex-shrink: 0; margin-left: 8px; }
        .story-location { color: #3498db; font-size: 0.85rem; margin-bottom: 6px; display: flex; align-items: center; }
        .story-preview { color: #666; font-size: 0.85rem; line-height: 1.3; max-height: 40px; overflow: hidden; }
        #editorModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .editor-content { width: 100%; height: 100%; background: white; display: flex; flex-direction: column; }
        .editor-header { padding: 20px 15px; border-bottom: 1px solid #eee; position: relative; }
        .editor-header h2 { color: #2c3e50; font-size: 1.2rem; }
        .editor-header .location-info { color: #7f8c8d; font-size: 0.85rem; margin-top: 5px; line-height: 1.3; }
        .editor-toolbar { padding: 12px 15px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; gap: 8px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .editor-toolbar button { padding: 8px 12px; background: white; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 0.9rem; flex-shrink: 0; }
        #storyEditor { flex: 1; padding: 15px; font-size: 1rem; line-height: 1.5; overflow-y: auto; outline: none; border: none; min-height: 200px; -webkit-overflow-scrolling: touch; }
        .editor-footer { padding: 15px; border-top: 1px solid #eee; display: flex; justify-content: space-between; gap: 10px; }
        .editor-footer button { padding: 12px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 1rem; flex: 1; }
        #saveStory { background: #3498db; color: white; }
        #closeEditor { background: #ecf0f1; color: #333; }
        #toggleRoute, #recordStory { position: absolute; z-index: 10; background: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: #2c3e50; box-shadow: 0 2px 8px rgba(0,0,0,0.1); font-size: 0.9rem; padding: 10px 15px; white-space: nowrap; }
        #toggleRoute { top: 15px; left: 15px; }
        #recordStory { top: 15px; right: 15px; background: #2ecc71; color: white; }
        .status-box { background: #e8f4fd; border: 1px solid #b6e0fe; border-radius: 8px; padding: 12px; margin: 0 15px 12px; font-size: 0.85rem; }
        .status-box.success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .status-box.error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .map-loading { display: flex; justify-content: center; align-items: center; height: 100%; background: #f0f2f5; color: #666; font-size: 1rem; }
        #mapLoading { display: none; }
        /* å›¾ç‰‡ä¸Šä¼ æ ·å¼ */
        .image-upload-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; }
        .image-upload-content { background: white; border-radius: 15px; width: 90%; max-width: 400px; margin: 20% auto; padding: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .image-upload-content h3 { margin-bottom: 20px; color: #2c3e50; text-align: center; font-size: 1.2rem; }
        .upload-options { display: flex; flex-direction: column; gap: 15px; }
        .upload-option { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; }
        .upload-option i { font-size: 2rem; margin-bottom: 10px; color: #3498db; }
        .upload-option span { display: block; font-weight: 600; color: #2c3e50; font-size: 1rem; }
        .upload-option p { font-size: 0.85rem; color: #7f8c8d; margin-top: 5px; }
        #cameraInput, #fileInput { display: none; }
        .close-upload { background: #e74c3c; color: white; border: none; border-radius: 8px; padding: 12px; margin-top: 20px; width: 100%; cursor: pointer; font-weight: 600; font-size: 1rem; }
        .image-preview { max-width: 100%; max-height: 200px; border-radius: 8px; margin: 10px 0; display: none; }
        /* å“åº”å¼è°ƒæ•´ */
        @media (min-width: 768px) {
            body { flex-direction: row; }
            #mapContainer { height: 100%; width: 60%; }
            #sidebar { width: 40%; height: 100%; border-left: 1px solid #e1e5eb; border-top: none; }
            .sidebar-toggle { display: none; }
        }
        @media (max-width: 767px) {
            .sidebar-toggle { display: block; }
            .sidebar-collapsed #sidebar { display: none; }
            .sidebar-collapsed #mapContainer { height: 100vh; }
        }
        /* æ·»åŠ ç§»åŠ¨ç«¯ä¼˜åŒ– */
        input, textarea, button, select { font-size: 16px; } /* é˜²æ­¢iOSç¼©æ”¾ */
        .no-select { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        /* æ•…äº‹å¡ç‰‡è§¦æ‘¸ä¼˜åŒ– */
        .story-card { transition: transform 0.2s ease; }
        .story-card:active { transform: scale(0.98); }
        /* åœ°å›¾æ§ä»¶ä¼˜åŒ– */
        .amap-logo, .amap-copyright { display: none !important; }
    </style>
</head>
<body class="no-select">
    <div id="mapContainer">
        <div id="mapLoading" class="map-loading"></div>
    </div>
    
    <button id="toggleRoute">ğŸ“ è·¯çº¿</button>
    <button id="recordStory">ğŸ“ è®°å½•</button>
    
    <button class="sidebar-toggle" id="sidebarToggle">ğŸ“–</button>
    
    <div id="sidebar">
        <div class="logo">
            <h1>ğŸ—ºï¸ PathLife æ•…äº‹åœ°å›¾</h1>
            <p>è®°å½•æ—…ç¨‹ï¼Œä¸²è”æ¯ä¸ªæ•…äº‹ç¬é—´</p>
        </div>
        <div class="status-box success" id="keyStatus">
            âœ… åœ°å›¾å·²åŠ è½½
        </div>
        <div class="location-box">
            <div class="location-container">
                <div id="currentLocationInfo">
                    <h3>ğŸ“ å½“å‰ä½ç½®ä¿¡æ¯</h3>
                    <p><strong>åœ°å€ï¼š</strong><span id="locationAddress">æ­£åœ¨è·å–ä½ç½®...</span></p>
                    <p><strong>åæ ‡ï¼š</strong><span id="locationCoords">-</span></p>
                    <p><strong>çŠ¶æ€ï¼š</strong><span id="locationStatus">å®šä½ä¸­...</span></p>
                </div>
                <button id="locateButton">ğŸ“ æ›´æ–°æˆ‘çš„ä½ç½®</button>
            </div>
        </div>
        <div class="stories-list" id="storiesList"></div>
    </div>
    
    <!-- ç¼–è¾‘å™¨æ¨¡æ€æ¡† -->
    <div id="editorModal">
        <div class="editor-content">
            <div class="editor-header">
                <h2>âœï¸ ç¼–è¾‘æ•…äº‹</h2>
                <div class="location-info" id="editorLocation"></div>
            </div>
            <div class="editor-toolbar">
                <button onclick="formatText('bold')"><b>B</b></button>
                <button onclick="formatText('italic')"><i>I</i></button>
                <button onclick="formatText('insertUnorderedList')">ğŸ“‹ åˆ—è¡¨</button>
                <button onclick="showImageUpload()">ğŸ–¼ï¸ å›¾ç‰‡</button>
            </div>
            <div id="storyEditor" contenteditable="true" placeholder="å†™ä¸‹ä½ çš„æ•…äº‹..."></div>
            <div class="editor-footer">
                <button id="closeEditor">å–æ¶ˆ</button>
                <button id="saveStory">ä¿å­˜æ•…äº‹</button>
            </div>
        </div>
    </div>
    
    <!-- å›¾ç‰‡ä¸Šä¼ æ¨¡æ€æ¡† -->
    <div id="imageUploadModal" class="image-upload-modal">
        <div class="image-upload-content">
            <h3>ğŸ“¸ æ·»åŠ å›¾ç‰‡</h3>
            <div class="upload-options">
                <div class="upload-option" onclick="openCamera()">
                    <i>ğŸ“·</i>
                    <span>æ‹ç…§</span>
                    <p>ä½¿ç”¨æ‘„åƒå¤´æ‹æ‘„æ–°ç…§ç‰‡</p>
                </div>
                <div class="upload-option" onclick="openFilePicker()">
                    <i>ğŸ“</i>
                    <span>ä¸Šä¼ å›¾ç‰‡</span>
                    <p>ä»ç›¸å†Œæˆ–æ–‡ä»¶ä¸­é€‰æ‹©å›¾ç‰‡</p>
                </div>
                <img id="imagePreview" class="image-preview" alt="å›¾ç‰‡é¢„è§ˆ">
                <button class="close-upload" onclick="closeImageUpload()">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥å’Œç›¸æœºè¾“å…¥ -->
    <input type="file" id="cameraInput" accept="image/*" capture="environment">
    <input type="file" id="fileInput" accept="image/*">

    <script>
        // é…ç½®
        const AMapKey = '0874b5c6096d30f6f75ae6949f5c4468';
        
        // å…¨å±€å˜é‡
        let map = null;
        let markers = [];
        let currentPlace = null;
        let editingStoryId = null;
        let routeLine = null;
        let isRouteVisible = false;
        let stories = JSON.parse(localStorage.getItem('pathLifeStories')) || [];
        let mapInitialized = false;
        let geocoder = null;
        let currentPositionMarker = null;
        let isSidebarCollapsed = false;

        // æ£€æŸ¥é«˜å¾·åœ°å›¾APIæ˜¯å¦åŠ è½½æˆåŠŸ
        function checkAMapLoaded() {
            if (typeof AMap === 'undefined') {
                document.getElementById('keyStatus').innerHTML = 'âŒ åœ°å›¾åŠ è½½å¤±è´¥';
                document.getElementById('keyStatus').className = 'status-box error';
                return false;
            }
            return true;
        }

        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            if (!checkAMapLoaded()) {
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('mapLoading').style.display = 'flex';
            
            try {
                // ä»¥æ­¦æ±‰ä¸ºä¸­å¿ƒ (æ­¦æ±‰åæ ‡: 114.298572, 30.584355)
                map = new AMap.Map('mapContainer', {
                    zoom: 12,
                    center: [114.298572, 30.584355],
                    viewMode: '2D',
                    resizeEnable: true,
                    touchZoom: true,
                    dragEnable: true,
                    zoomEnable: true,
                    doubleClickZoom: true
                });
                
                console.log('åœ°å›¾åˆå§‹åŒ–æˆåŠŸ');
                
                // éšè—åŠ è½½çŠ¶æ€
                document.getElementById('mapLoading').style.display = 'none';
                
                // æ›´æ–°çŠ¶æ€
                document.getElementById('keyStatus').innerHTML = 'âœ… åœ°å›¾å·²åŠ è½½å®Œæˆ';
                document.getElementById('keyStatus').className = 'status-box success';
                
                mapInitialized = true;
                
                // åˆå§‹åŒ–åœ°ç†ç¼–ç æœåŠ¡
                geocoder = new AMap.Geocoder({
                    city: "å…¨å›½"
                });
                
                // åŠ è½½å·²æœ‰æ•…äº‹
                loadStoriesOnMap();
                renderStoryList();
                
                // è‡ªåŠ¨å®šä½
                autoLocate();
                
                // æ·»åŠ åœ°å›¾ç‚¹å‡»äº‹ä»¶
                map.on('click', function(e) {
                    const lng = e.lnglat.getLng();
                    const lat = e.lnglat.getLat();
                    updateCurrentPosition(lng, lat, true);
                });
                
            } catch (error) {
                console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
                document.getElementById('mapLoading').style.display = 'none';
                document.getElementById('keyStatus').innerHTML = 'âŒ åœ°å›¾åŠ è½½å¤±è´¥';
                document.getElementById('keyStatus').className = 'status-box error';
            }
        }

        // è‡ªåŠ¨å®šä½
        function autoLocate() {
            updateLocationStatus('æ­£åœ¨è·å–æ‚¨çš„ä½ç½®...');
            
            // å…ˆå°è¯•ä½¿ç”¨æµè§ˆå™¨å®šä½
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lng = position.coords.longitude;
                        const lat = position.coords.latitude;
                        updateCurrentPosition(lng, lat, false);
                        updateLocationStatus('å®šä½æˆåŠŸï¼');
                    },
                    function(error) {
                        console.log('æµè§ˆå™¨å®šä½å¤±è´¥');
                        updateLocationStatus('ç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®æˆ–ä½¿ç”¨æ›´æ–°æŒ‰é’®');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                console.log('æµè§ˆå™¨ä¸æ”¯æŒå®šä½');
                updateLocationStatus('ç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®æˆ–ä½¿ç”¨æ›´æ–°æŒ‰é’®');
            }
        }

        // æ›´æ–°å½“å‰ä½ç½®
        function updateCurrentPosition(lng, lat, fromClick = false) {
            // æ¸…é™¤ä¹‹å‰çš„å½“å‰ä½ç½®æ ‡è®°
            if (currentPositionMarker) {
                map.remove(currentPositionMarker);
            }
            
            // æ·»åŠ æ–°çš„å½“å‰ä½ç½®æ ‡è®°
            currentPositionMarker = new AMap.Marker({
                position: [lng, lat],
                map: map,
                title: 'å½“å‰ä½ç½®',
                content: '<div style="background:#e74c3c;color:white;border-radius:50%;width:24px;height:24px;text-align:center;line-height:24px;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);">ğŸ“</div>',
                offset: new AMap.Pixel(-12, -12),
                animation: "AMAP_ANIMATION_DROP"
            });
            
            // å¦‚æœæ˜¯ä»åœ°å›¾ç‚¹å‡»çš„ï¼Œå®šä½åˆ°è¯¥ä½ç½®
            if (fromClick) {
                map.setCenter([lng, lat]);
                map.setZoom(16);
                updateLocationStatus('å·²é€‰æ‹©æ–°ä½ç½®');
            } else {
                map.setCenter([lng, lat]);
                map.setZoom(15);
            }
            
            // æ›´æ–°åæ ‡æ˜¾ç¤º
            document.getElementById('locationCoords').textContent = 
                lng.toFixed(6) + ', ' + lat.toFixed(6);
            
            // è·å–åœ°å€ä¿¡æ¯
            getAddressFromCoords(lng, lat);
            
            // å­˜å‚¨å½“å‰ä½ç½®ä¿¡æ¯
            currentPlace = {
                location: { lng, lat }
            };
        }

        // æ ¹æ®åæ ‡è·å–åœ°å€
        function getAddressFromCoords(lng, lat) {
            if (!geocoder) return;
            
            geocoder.getAddress([lng, lat], function(status, result) {
                if (status === 'complete' && result.info === 'OK') {
                    const address = result.regeocode.formattedAddress;
                    document.getElementById('locationAddress').textContent = address;
                    
                    // æ›´æ–°å½“å‰ä½ç½®ä¿¡æ¯
                    if (currentPlace) {
                        currentPlace.name = result.regeocode.addressComponent.neighborhood || 
                                          result.regeocode.addressComponent.street || 
                                          'å½“å‰ä½ç½®';
                        currentPlace.address = address;
                    }
                } else {
                    document.getElementById('locationAddress').textContent = 'æ— æ³•è·å–è¯¦ç»†åœ°å€';
                    if (currentPlace) {
                        currentPlace.name = 'å½“å‰ä½ç½®';
                        currentPlace.address = 'åæ ‡: ' + lng.toFixed(6) + ', ' + lat.toFixed(6);
                    }
                }
            });
        }

        // æ›´æ–°å®šä½çŠ¶æ€
        function updateLocationStatus(message) {
            document.getElementById('locationStatus').textContent = message;
        }

        // æ‰“å¼€ç¼–è¾‘å™¨
        function openEditor(place, storyId = null) {
            if (!place) {
                alert('è¯·å…ˆè·å–ä½ç½®ä¿¡æ¯');
                return;
            }
            
            editingStoryId = storyId;
            document.getElementById('editorLocation').innerHTML = `
                <strong>åœ°ç‚¹ï¼š</strong>${place.name || 'å½“å‰ä½ç½®'}<br>
                <small>${place.address || 'åæ ‡: ' + place.location.lng.toFixed(6) + ', ' + place.location.lat.toFixed(6)}</small>
            `;
            
            const editor = document.getElementById('storyEditor');
            if (storyId) {
                const story = stories.find(s => s.id === storyId);
                editor.innerHTML = story?.content || '';
            } else {
                editor.innerHTML = '<p>åœ¨æ­¤å†™ä¸‹ä½ çš„æ•…äº‹...</p>';
            }
            
            document.getElementById('editorModal').style.display = 'block';
            setTimeout(() => editor.focus(), 100);
        }

        // ä¿å­˜æ•…äº‹
        function saveStory() {
            if (!currentPlace) return;
            
            const editor = document.getElementById('storyEditor');
            const content = editor.innerHTML.trim();
            const textContent = editor.innerText.trim();
            
            if (!textContent || textContent === 'åœ¨æ­¤å†™ä¸‹ä½ çš„æ•…äº‹...') {
                alert('è¯·è¾“å…¥æ•…äº‹å†…å®¹');
                return;
            }
            
            const storyData = {
                id: editingStoryId || Date.now().toString(),
                title: textContent.substring(0, 30) || 'æˆ‘çš„æ•…äº‹',
                placeName: currentPlace.name || 'å½“å‰ä½ç½®',
                lng: currentPlace.location.lng,
                lat: currentPlace.location.lat,
                address: currentPlace.address || `åæ ‡: ${currentPlace.location.lng.toFixed(6)}, ${currentPlace.location.lat.toFixed(6)}`,
                content: content,
                time: new Date().toLocaleString(),
                timestamp: Date.now()
            };
            
            // æ›´æ–°æˆ–æ·»åŠ æ•…äº‹
            const index = stories.findIndex(s => s.id === storyData.id);
            if (index > -1) {
                stories[index] = storyData;
            } else {
                stories.push(storyData);
            }
            
            // æŒ‰æ—¶é—´æ’åº
            stories.sort((a, b) => b.timestamp - a.timestamp);
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('pathLifeStories', JSON.stringify(stories));
            
            // æ›´æ–°ç•Œé¢
            loadStoriesOnMap();
            renderStoryList();
            closeEditor();
            
            // ç§»åŠ¨ç«¯å‹å¥½çš„æç¤º
            const msg = document.createElement('div');
            msg.innerHTML = '<div style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.8); color:white; padding:15px 25px; border-radius:10px; z-index:3000;">âœ… æ•…äº‹å·²ä¿å­˜ï¼</div>';
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 2000);
        }

        // åœ¨åœ°å›¾ä¸ŠåŠ è½½æ•…äº‹æ ‡è®°
        function loadStoriesOnMap() {
            if (!map) return;
            
            // æ¸…é™¤æ—§çš„æ•…äº‹æ ‡è®°ï¼ˆä¿ç•™å½“å‰ä½ç½®æ ‡è®°ï¼‰
            markers.forEach(marker => {
                if (marker !== currentPositionMarker) {
                    map.remove(marker);
                }
            });
            markers = currentPositionMarker ? [currentPositionMarker] : [];
            
            stories.forEach(story => {
                const marker = new AMap.Marker({
                    position: [story.lng, story.lat],
                    map: map,
                    title: story.placeName,
                    content: '<div style="background:#27ae60;color:white;border-radius:50%;width:20px;height:20px;text-align:center;line-height:20px;">ğŸ“–</div>',
                    offset: new AMap.Pixel(-10, -10)
                });
                
                marker.on('click', () => {
                    highlightStoryCard(story.id);
                    const infoWindow = new AMap.InfoWindow({
                        content: `
                            <div style="padding:10px;max-width:250px;">
                                <h4 style="margin:0 0 5px 0;">${story.placeName}</h4>
                                <p style="color:#666;font-size:12px;margin:0 0 8px 0;">${story.time}</p>
                                <div style="font-size:13px;line-height:1.4;max-height:80px;overflow:hidden;">
                                    ${story.content.replace(/<[^>]+>/g, '').substring(0, 80)}...
                                </div>
                                <button onclick="editStory('${story.id}')" style="background:#3498db;color:white;border:none;padding:5px 10px;border-radius:4px;margin-top:8px;cursor:pointer;font-size:12px;">ç¼–è¾‘</button>
                            </div>
                        `
                    });
                    infoWindow.open(map, [story.lng, story.lat]);
                });
                
                markers.push(marker);
            });
            
            updateRouteLine();
        }

        // æ¸²æŸ“æ•…äº‹åˆ—è¡¨
        function renderStoryList() {
            const container = document.getElementById('storiesList');
            
            if (stories.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;padding:30px 15px;color:#95a5a6;">
                        <p style="font-size:1.1rem;margin-bottom:8px;">è¿˜æ²¡æœ‰æ•…äº‹è®°å½•</p>
                        <p style="font-size:0.9rem;">ç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®ï¼Œç„¶åç‚¹å‡»"è®°å½•"æŒ‰é’®å¼€å§‹è®°å½•</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = stories.map(story => `
                <div class="story-card" data-id="${story.id}" onclick="focusOnStory('${story.id}')">
                    <div class="story-header">
                        <div class="story-title">${story.title}</div>
                        <div class="story-time">${story.time}</div>
                    </div>
                    <div class="story-location">ğŸ“ ${story.placeName}</div>
                    <div class="story-preview">${story.content.replace(/<[^>]+>/g, '').substring(0, 80)}...</div>
                </div>
            `).join('');
        }

        // èšç„¦åˆ°æ•…äº‹åœ°ç‚¹
        function focusOnStory(storyId) {
            const story = stories.find(s => s.id === storyId);
            if (story && map) {
                map.setCenter([story.lng, story.lat]);
                map.setZoom(16);
                highlightStoryCard(storyId);
            }
        }

        // é«˜äº®æ•…äº‹å¡ç‰‡
        function highlightStoryCard(storyId) {
            document.querySelectorAll('.story-card').forEach(card => {
                card.classList.remove('active');
            });
            const card = document.querySelector(`.story-card[data-id="${storyId}"]`);
            if (card) card.classList.add('active');
        }

        // ç¼–è¾‘æ•…äº‹
        function editStory(storyId) {
            const story = stories.find(s => s.id === storyId);
            if (!story) return;
            
            currentPlace = {
                name: story.placeName,
                location: { lng: story.lng, lat: story.lat },
                address: story.address
            };
            
            openEditor(currentPlace, storyId);
        }

        // æ›´æ–°è·¯çº¿è¿çº¿
        function updateRouteLine() {
            if (!map) return;
            
            if (routeLine) {
                map.remove(routeLine);
                routeLine = null;
            }
            
            if (stories.length < 2 || !isRouteVisible) return;
            
            const sortedStories = [...stories].sort((a, b) => a.timestamp - b.timestamp);
            const linePath = sortedStories.map(s => [s.lng, s.lat]);
            
            routeLine = new AMap.Polyline({
                path: linePath,
                strokeColor: "#3498db",
                strokeOpacity: 0.8,
                strokeWeight: 4,
                strokeStyle: "solid"
            });
            
            map.add(routeLine);
            map.setFitView();
        }

        // åˆ‡æ¢è·¯çº¿æ˜¾ç¤º
        function toggleRoute() {
            isRouteVisible = !isRouteVisible;
            document.getElementById('toggleRoute').textContent = 
                isRouteVisible ? 'ğŸ“ éšè—è·¯çº¿' : 'ğŸ“ æ˜¾ç¤ºè·¯çº¿';
            updateRouteLine();
        }

        // åˆ‡æ¢ä¾§è¾¹æ æ˜¾ç¤º
        function toggleSidebar() {
            isSidebarCollapsed = !isSidebarCollapsed;
            document.body.classList.toggle('sidebar-collapsed', isSidebarCollapsed);
            document.getElementById('sidebarToggle').textContent = 
                isSidebarCollapsed ? 'ğŸ“–' : 'ğŸ—ºï¸';
        }

        // ç¼–è¾‘å™¨åŠŸèƒ½
        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('storyEditor').focus();
        }
        
        // æ˜¾ç¤ºå›¾ç‰‡ä¸Šä¼ é€‰é¡¹
        function showImageUpload() {
            document.getElementById('imageUploadModal').style.display = 'block';
        }
        
        // å…³é—­å›¾ç‰‡ä¸Šä¼ 
        function closeImageUpload() {
            document.getElementById('imageUploadModal').style.display = 'none';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imagePreview').src = '';
        }
        
        // æ‰“å¼€ç›¸æœº
        function openCamera() {
            document.getElementById('cameraInput').click();
        }
        
        // æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨
        function openFilePicker() {
            document.getElementById('fileInput').click();
        }
        
        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        function handleImageUpload(file) {
            if (!file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const imgData = e.target.result;
                
                // æ˜¾ç¤ºé¢„è§ˆ
                const preview = document.getElementById('imagePreview');
                preview.src = imgData;
                preview.style.display = 'block';
                
                // æ’å…¥åˆ°ç¼–è¾‘å™¨
                setTimeout(() => {
                    insertImageToEditor(imgData);
                    closeImageUpload();
                }, 1000);
            };
            reader.readAsDataURL(file);
        }
        
        // å°†å›¾ç‰‡æ’å…¥åˆ°ç¼–è¾‘å™¨
        function insertImageToEditor(imgData) {
            const editor = document.getElementById('storyEditor');
            const img = `<img src="${imgData}" style="max-width:100%;border-radius:8px;margin:10px 0;" alt="æ•…äº‹å›¾ç‰‡">`;
            document.execCommand('insertHTML', false, img);
            editor.focus();
        }

        // å…³é—­ç¼–è¾‘å™¨
        function closeEditor() {
            document.getElementById('editorModal').style.display = 'none';
            document.getElementById('storyEditor').innerHTML = '';
            editingStoryId = null;
        }

        // è®°å½•æ•…äº‹æŒ‰é’®ç‚¹å‡»
        function recordStory() {
            if (!currentPlace) {
                // ç§»åŠ¨ç«¯å‹å¥½çš„æç¤º
                const msg = document.createElement('div');
                msg.innerHTML = '<div style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.8); color:white; padding:15px 25px; border-radius:10px; z-index:3000;">è¯·å…ˆè·å–ä½ç½®ä¿¡æ¯</div>';
                document.body.appendChild(msg);
                setTimeout(() => msg.remove(), 2000);
                return;
            }
            openEditor(currentPlace);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–åœ°å›¾...');
            
            // æ£€æŸ¥APIæ˜¯å¦åŠ è½½æˆåŠŸ
            if (!checkAMapLoaded()) {
                // å¦‚æœAPIæœªåŠ è½½ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´å†æ£€æŸ¥
                setTimeout(() => {
                    if (!checkAMapLoaded()) {
                        document.getElementById('keyStatus').innerHTML = 'âŒ åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                        document.getElementById('keyStatus').className = 'status-box error';
                    } else {
                        initMap();
                    }
                }, 2000);
            } else {
                // APIå·²åŠ è½½ï¼Œåˆå§‹åŒ–åœ°å›¾
                initMap();
            }
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('locateButton').addEventListener('click', autoLocate);
            document.getElementById('saveStory').addEventListener('click', saveStory);
            document.getElementById('closeEditor').addEventListener('click', closeEditor);
            document.getElementById('toggleRoute').addEventListener('click', toggleRoute);
            document.getElementById('recordStory').addEventListener('click', recordStory);
            document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
            
            // å›¾ç‰‡ä¸Šä¼ äº‹ä»¶
            document.getElementById('cameraInput').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    handleImageUpload(e.target.files[0]);
                }
            });
            
            document.getElementById('fileInput').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    handleImageUpload(e.target.files[0]);
                }
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            document.getElementById('editorModal').addEventListener('click', function(e) {
                if (e.target === this) closeEditor();
            });
            
            document.getElementById('imageUploadModal').addEventListener('click', function(e) {
                if (e.target === this) closeImageUpload();
            });
            
            // é€‚é…ç§»åŠ¨ç«¯é”®ç›˜å¼¹å‡º
            window.addEventListener('resize', function() {
                if (document.activeElement.tagName === 'TEXTAREA' || 
                    document.activeElement.tagName === 'INPUT') {
                    setTimeout(() => {
                        document.activeElement.scrollIntoView({behavior: 'smooth', block: 'center'});
                    }, 300);
                }
            });
        };
    </script>
</body>
</html>
