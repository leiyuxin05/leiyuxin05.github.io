<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PathLife - æ•…äº‹åœ°å›¾</title>
    <!-- å¼•å…¥é«˜å¾·åœ°å›¾JS API -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=0874b5c6096d30f6f75ae6949f5c4468"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; }
        body { display: flex; height: 100vh; background: #f5f7fa; color: #333; overflow: hidden; }
        #mapContainer { flex: 1; height: 100%; min-height: 400px; }
        #sidebar { width: 380px; background: white; border-left: 1px solid #e1e5eb; display: flex; flex-direction: column; }
        .logo { padding: 20px; border-bottom: 1px solid #e1e5eb; }
        .logo h1 { font-size: 1.5rem; color: #2c3e50; }
        .logo p { color: #7f8c8d; font-size: 0.9rem; margin-top: 5px; }
        .location-box { padding: 20px; border-bottom: 1px solid #e1e5eb; }
        .location-container { display: flex; flex-direction: column; gap: 10px; }
        #currentLocationInfo { background: #f8f9fa; border: 1px solid #e1e5eb; border-radius: 8px; padding: 15px; font-size: 0.9rem; line-height: 1.5; }
        #currentLocationInfo h3 { color: #2c3e50; margin-bottom: 8px; font-size: 1rem; }
        #currentLocationInfo p { color: #666; margin: 4px 0; }
        #locateButton { background: #3498db; color: white; border: none; border-radius: 8px; padding: 12px 20px; cursor: pointer; font-weight: bold; font-size: 0.95rem; width: 100%; }
        #locateButton:hover { background: #2980b9; }
        .stories-list { flex: 1; overflow-y: auto; padding: 20px; }
        .story-card { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 10px; padding: 15px; margin-bottom: 15px; cursor: pointer; }
        .story-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-2px); }
        .story-card.active { border-color: #3498db; background: #e3f2fd; }
        .story-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .story-title { font-weight: bold; color: #2c3e50; }
        .story-time { color: #95a5a6; font-size: 0.8rem; }
        .story-location { color: #3498db; font-size: 0.9rem; margin-bottom: 8px; }
        .story-preview { color: #666; font-size: 0.9rem; line-height: 1.4; max-height: 60px; overflow: hidden; }
        #editorModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .editor-content { width: 90%; max-width: 800px; height: 80%; background: white; border-radius: 15px; display: flex; flex-direction: column; overflow: hidden; }
        .editor-header { padding: 20px; border-bottom: 1px solid #eee; }
        .editor-header h2 { color: #2c3e50; }
        .editor-header .location-info { color: #7f8c8d; font-size: 0.9rem; margin-top: 5px; }
        .editor-toolbar { padding: 10px 20px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; gap: 10px; }
        .editor-toolbar button { padding: 8px 15px; background: white; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; }
        #storyEditor { flex: 1; padding: 20px; font-size: 1rem; line-height: 1.6; overflow-y: auto; outline: none; border: none; min-height: 200px; }
        .editor-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
        .editor-footer button { padding: 10px 25px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        #saveStory { background: #3498db; color: white; }
        #saveStory:hover { background: #2980b9; }
        #closeEditor { background: #ecf0f1; color: #333; }
        #closeEditor:hover { background: #d5dbdb; }
        #toggleRoute { position: absolute; top: 20px; left: 20px; z-index: 10; background: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; color: #2c3e50; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        #recordStory { position: absolute; top: 70px; left: 20px; z-index: 10; background: #2ecc71; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .status-box { background: #e8f4fd; border: 1px solid #b6e0fe; border-radius: 8px; padding: 15px; margin: 0 20px 15px; font-size: 0.9rem; }
        .status-box.success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .status-box.error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .loading { text-align: center; padding: 10px; color: #7f8c8d; font-size: 0.9rem; }
        .map-loading { display: flex; justify-content: center; align-items: center; height: 100%; background: #f0f2f5; color: #666; font-size: 1.1rem; }
        #mapLoading { display: none; }
        /* å›¾ç‰‡ä¸Šä¼ æ ·å¼ */
        .image-upload-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; }
        .image-upload-content { background: white; border-radius: 15px; width: 90%; max-width: 400px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .image-upload-content h3 { margin-bottom: 20px; color: #2c3e50; text-align: center; }
        .upload-options { display: flex; flex-direction: column; gap: 15px; }
        .upload-option { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s ease; }
        .upload-option:hover { background: #e9ecef; border-color: #3498db; transform: translateY(-3px); }
        .upload-option i { font-size: 2rem; margin-bottom: 10px; color: #3498db; }
        .upload-option span { display: block; font-weight: 600; color: #2c3e50; }
        .upload-option p { font-size: 0.9rem; color: #7f8c8d; margin-top: 5px; }
        #cameraInput, #fileInput { display: none; }
        .close-upload { background: #e74c3c; color: white; border: none; border-radius: 8px; padding: 10px 20px; margin-top: 20px; width: 100%; cursor: pointer; font-weight: bold; }
        .image-preview { max-width: 100%; max-height: 300px; border-radius: 8px; margin: 10px 0; display: none; }
        @media (max-width: 768px) {
            body { flex-direction: column; }
            #sidebar { width: 100%; height: 45%; border-left: none; border-top: 1px solid #e1e5eb; }
            #mapContainer { height: 55%; }
            #toggleRoute, #recordStory { top: 10px; }
            #recordStory { top: 60px; }
        }
    </style>
</head>
<body>
    <div id="mapContainer">
        <div id="mapLoading" class="map-loading">
            <div>
                <!-- è¿™é‡Œå·²ç§»é™¤åœ°å›¾åŠ è½½å¤±è´¥çš„æç¤ºè¯­ -->
            </div>
        </div>
    </div>
    <button id="toggleRoute">ğŸ“ æ˜¾ç¤ºè·¯çº¿å›¾</button>
    <button id="recordStory">ğŸ“ è®°å½•æ•…äº‹</button>
    <div id="sidebar">
        <div class="logo">
            <h1>ğŸ—ºï¸ PathLife æ•…äº‹åœ°å›¾</h1>
            <p>è®°å½•æ—…ç¨‹ï¼Œä¸²è”æ¯ä¸ªæ•…äº‹ç¬é—´</p>
        </div>
        <div class="status-box success" id="keyStatus">
            âœ… é«˜å¾·åœ°å›¾APIå·²åŠ è½½
        </div>
        <div class="location-box">
            <div class="location-container">
                <div id="currentLocationInfo">
                    <h3>ğŸ“ å½“å‰ä½ç½®ä¿¡æ¯</h3>
                    <p><strong>åœ°å€ï¼š</strong><span id="locationAddress">æ­£åœ¨è·å–ä½ç½®...</span></p>
                    <p><strong>åæ ‡ï¼š</strong><span id="locationCoords">-</span></p>
                    <p><strong>çŠ¶æ€ï¼š</strong><span id="locationStatus">å®šä½ä¸­...</span></p>
                </div>
                <button id="locateButton">ğŸ“ æ›´æ–°æˆ‘çš„ä½ç½®</button>
            </div>
        </div>
        <div class="stories-list" id="storiesList"></div>
    </div>
    <div id="editorModal">
        <div class="editor-content">
            <div class="editor-header">
                <h2>âœï¸ ç¼–è¾‘æ•…äº‹</h2>
                <div class="location-info" id="editorLocation"></div>
            </div>
            <div class="editor-toolbar">
                <button onclick="formatText('bold')"><b>B</b></button>
                <button onclick="formatText('italic')"><i>I</i></button>
                <button onclick="formatText('insertUnorderedList')">ğŸ“‹ åˆ—è¡¨</button>
                <button onclick="showImageUpload()">ğŸ–¼ï¸ å›¾ç‰‡</button>
            </div>
            <div id="storyEditor" contenteditable="true" placeholder="å†™ä¸‹ä½ çš„æ•…äº‹..."></div>
            <div class="editor-footer">
                <button id="closeEditor">å–æ¶ˆ</button>
                <button id="saveStory">ä¿å­˜æ•…äº‹</button>
            </div>
        </div>
    </div>
    
    <!-- å›¾ç‰‡ä¸Šä¼ æ¨¡æ€æ¡† -->
    <div id="imageUploadModal" class="image-upload-modal">
        <div class="image-upload-content">
            <h3>ğŸ“¸ æ·»åŠ å›¾ç‰‡</h3>
            <div class="upload-options">
                <div class="upload-option" onclick="openCamera()">
                    <i>ğŸ“·</i>
                    <span>æ‹ç…§</span>
                    <p>ä½¿ç”¨æ‘„åƒå¤´æ‹æ‘„æ–°ç…§ç‰‡</p>
                </div>
                <div class="upload-option" onclick="openFilePicker()">
                    <i>ğŸ“</i>
                    <span>ä¸Šä¼ å›¾ç‰‡</span>
                    <p>ä»ç›¸å†Œæˆ–æ–‡ä»¶ä¸­é€‰æ‹©å›¾ç‰‡</p>
                </div>
                <img id="imagePreview" class="image-preview" alt="å›¾ç‰‡é¢„è§ˆ">
                <button class="close-upload" onclick="closeImageUpload()">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥å’Œç›¸æœºè¾“å…¥ -->
    <input type="file" id="cameraInput" accept="image/*" capture="environment">
    <input type="file" id="fileInput" accept="image/*">

    <script>
        // é…ç½®
        const AMapKey = '0874b5c6096d30f6f75ae6949f5c4468';
        
        // å…¨å±€å˜é‡
        let map = null;
        let markers = [];
        let currentPlace = null;
        let editingStoryId = null;
        let routeLine = null;
        let isRouteVisible = false;
        let stories = JSON.parse(localStorage.getItem('pathLifeStories')) || [];
        let mapInitialized = false;
        let geocoder = null;
        let currentPositionMarker = null;

        // æ£€æŸ¥é«˜å¾·åœ°å›¾APIæ˜¯å¦åŠ è½½æˆåŠŸ
        function checkAMapLoaded() {
            if (typeof AMap === 'undefined') {
                document.getElementById('keyStatus').innerHTML = 'âŒ é«˜å¾·åœ°å›¾APIåŠ è½½å¤±è´¥';
                document.getElementById('keyStatus').className = 'status-box error';
                return false;
            }
            return true;
        }

        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            if (!checkAMapLoaded()) {
                // åªæ›´æ–°çŠ¶æ€ï¼Œä¸æ˜¾ç¤ºå¼¹çª—
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('mapLoading').style.display = 'flex';
            
            try {
                // ä»¥æ­¦æ±‰ä¸ºä¸­å¿ƒ (æ­¦æ±‰åæ ‡: 114.298572, 30.584355)
                map = new AMap.Map('mapContainer', {
                    zoom: 12,
                    center: [114.298572, 30.584355], // æ­¦æ±‰
                    viewMode: '2D',
                    resizeEnable: true
                });
                
                console.log('åœ°å›¾åˆå§‹åŒ–æˆåŠŸï¼Œä»¥æ­¦æ±‰ä¸ºä¸­å¿ƒ');
                
                // éšè—åŠ è½½çŠ¶æ€
                document.getElementById('mapLoading').style.display = 'none';
                
                // æ›´æ–°çŠ¶æ€
                document.getElementById('keyStatus').innerHTML = 'âœ… åœ°å›¾å·²åŠ è½½å®Œæˆ';
                document.getElementById('keyStatus').className = 'status-box success';
                
                mapInitialized = true;
                
                // åˆå§‹åŒ–åœ°ç†ç¼–ç æœåŠ¡
                geocoder = new AMap.Geocoder({
                    city: "å…¨å›½"
                });
                
                // åŠ è½½å·²æœ‰æ•…äº‹
                loadStoriesOnMap();
                renderStoryList();
                
                // è‡ªåŠ¨å®šä½
                autoLocate();
                
                // æ·»åŠ åœ°å›¾ç‚¹å‡»äº‹ä»¶
                map.on('click', function(e) {
                    const lng = e.lnglat.getLng();
                    const lat = e.lnglat.getLat();
                    updateCurrentPosition(lng, lat, true);
                });
                
                // æ·»åŠ åœ°å›¾åŠ è½½å®Œæˆçš„äº‹ä»¶
                map.on('complete', function() {
                    console.log('åœ°å›¾èµ„æºåŠ è½½å®Œæˆ');
                });
                
            } catch (error) {
                console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
                // ç®€åŒ–é”™è¯¯å¤„ç†
                document.getElementById('mapLoading').style.display = 'none';
                document.getElementById('keyStatus').innerHTML = 'âŒ åœ°å›¾åŠ è½½å¤±è´¥';
                document.getElementById('keyStatus').className = 'status-box error';
            }
        }

        // è‡ªåŠ¨å®šä½
        function autoLocate() {
            updateLocationStatus('æ­£åœ¨è·å–æ‚¨çš„ä½ç½®...');
            
            // å…ˆå°è¯•ä½¿ç”¨æµè§ˆå™¨å®šä½
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lng = position.coords.longitude;
                        const lat = position.coords.latitude;
                        updateCurrentPosition(lng, lat, false);
                        updateLocationStatus('å®šä½æˆåŠŸï¼');
                    },
                    function(error) {
                        console.log('æµè§ˆå™¨å®šä½å¤±è´¥ï¼Œä½¿ç”¨åœ°å›¾ç‚¹å‡»é€‰æ‹©ä½ç½®');
                        updateLocationStatus('ç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®æˆ–ä½¿ç”¨æ›´æ–°æŒ‰é’®');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                console.log('æµè§ˆå™¨ä¸æ”¯æŒå®šä½');
                updateLocationStatus('ç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®æˆ–ä½¿ç”¨æ›´æ–°æŒ‰é’®');
            }
        }

        // æ›´æ–°å½“å‰ä½ç½®
        function updateCurrentPosition(lng, lat, fromClick = false) {
            // æ¸…é™¤ä¹‹å‰çš„å½“å‰ä½ç½®æ ‡è®°
            if (currentPositionMarker) {
                map.remove(currentPositionMarker);
            }
            
            // æ·»åŠ æ–°çš„å½“å‰ä½ç½®æ ‡è®°
            currentPositionMarker = new AMap.Marker({
                position: [lng, lat],
                map: map,
                title: 'å½“å‰ä½ç½®',
                content: '<div style="background:#e74c3c;color:white;border-radius:50%;width:24px;height:24px;text-align:center;line-height:24px;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);">ğŸ“</div>',
                offset: new AMap.Pixel(-12, -12),
                animation: "AMAP_ANIMATION_DROP"
            });
            
            // å¦‚æœæ˜¯ä»åœ°å›¾ç‚¹å‡»çš„ï¼Œå®šä½åˆ°è¯¥ä½ç½®
            if (fromClick) {
                map.setCenter([lng, lat]);
                map.setZoom(16);
                updateLocationStatus('å·²é€‰æ‹©æ–°ä½ç½®');
            } else {
                map.setCenter([lng, lat]);
                map.setZoom(15);
            }
            
            // æ›´æ–°åæ ‡æ˜¾ç¤º
            document.getElementById('locationCoords').textContent = 
                lng.toFixed(6) + ', ' + lat.toFixed(6);
            
            // è·å–åœ°å€ä¿¡æ¯
            getAddressFromCoords(lng, lat);
            
            // å­˜å‚¨å½“å‰ä½ç½®ä¿¡æ¯
            currentPlace = {
                location: { lng, lat }
            };
        }

        // æ ¹æ®åæ ‡è·å–åœ°å€
        function getAddressFromCoords(lng, lat) {
            if (!geocoder) return;
            
            geocoder.getAddress([lng, lat], function(status, result) {
                if (status === 'complete' && result.info === 'OK') {
                    const address = result.regeocode.formattedAddress;
                    document.getElementById('locationAddress').textContent = address;
                    
                    // æ›´æ–°å½“å‰ä½ç½®ä¿¡æ¯
                    if (currentPlace) {
                        currentPlace.name = result.regeocode.addressComponent.neighborhood || 
                                          result.regeocode.addressComponent.street || 
                                          'å½“å‰ä½ç½®';
                        currentPlace.address = address;
                    }
                } else {
                    document.getElementById('locationAddress').textContent = 'æ— æ³•è·å–è¯¦ç»†åœ°å€';
                    if (currentPlace) {
                        currentPlace.name = 'å½“å‰ä½ç½®';
                        currentPlace.address = 'åæ ‡: ' + lng.toFixed(6) + ', ' + lat.toFixed(6);
                    }
                }
            });
        }

        // æ›´æ–°å®šä½çŠ¶æ€
        function updateLocationStatus(message) {
            document.getElementById('locationStatus').textContent = message;
        }

        // æ‰“å¼€ç¼–è¾‘å™¨
        function openEditor(place, storyId = null) {
            if (!place) {
                alert('è¯·å…ˆè·å–ä½ç½®ä¿¡æ¯');
                return;
            }
            
            editingStoryId = storyId;
            document.getElementById('editorLocation').innerHTML = `
                <strong>åœ°ç‚¹ï¼š</strong>${place.name || 'å½“å‰ä½ç½®'}<br>
                <small>${place.address || 'åæ ‡: ' + place.location.lng.toFixed(6) + ', ' + place.location.lat.toFixed(6)}</small>
            `;
            
            const editor = document.getElementById('storyEditor');
            if (storyId) {
                const story = stories.find(s => s.id === storyId);
                editor.innerHTML = story?.content || '';
            } else {
                editor.innerHTML = '<p>åœ¨æ­¤å†™ä¸‹ä½ çš„æ•…äº‹...</p>';
            }
            
            document.getElementById('editorModal').style.display = 'flex';
            setTimeout(() => editor.focus(), 100);
        }

        // ä¿å­˜æ•…äº‹
        function saveStory() {
            if (!currentPlace) return;
            
            const editor = document.getElementById('storyEditor');
            const content = editor.innerHTML.trim();
            const textContent = editor.innerText.trim();
            
            if (!textContent || textContent === 'åœ¨æ­¤å†™ä¸‹ä½ çš„æ•…äº‹...') {
                alert('è¯·è¾“å…¥æ•…äº‹å†…å®¹');
                return;
            }
            
            const storyData = {
                id: editingStoryId || Date.now().toString(),
                title: textContent.substring(0, 30) || 'æˆ‘çš„æ•…äº‹',
                placeName: currentPlace.name || 'å½“å‰ä½ç½®',
                lng: currentPlace.location.lng,
                lat: currentPlace.location.lat,
                address: currentPlace.address || `åæ ‡: ${currentPlace.location.lng.toFixed(6)}, ${currentPlace.location.lat.toFixed(6)}`,
                content: content,
                time: new Date().toLocaleString(),
                timestamp: Date.now()
            };
            
            // æ›´æ–°æˆ–æ·»åŠ æ•…äº‹
            const index = stories.findIndex(s => s.id === storyData.id);
            if (index > -1) {
                stories[index] = storyData;
            } else {
                stories.push(storyData);
            }
            
            // æŒ‰æ—¶é—´æ’åº
            stories.sort((a, b) => b.timestamp - a.timestamp);
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('pathLifeStories', JSON.stringify(stories));
            
            // æ›´æ–°ç•Œé¢
            loadStoriesOnMap();
            renderStoryList();
            closeEditor();
            
            alert('âœ… æ•…äº‹å·²ä¿å­˜ï¼');
        }

        // åœ¨åœ°å›¾ä¸ŠåŠ è½½æ•…äº‹æ ‡è®°
        function loadStoriesOnMap() {
            if (!map) return;
            
            // æ¸…é™¤æ—§çš„æ•…äº‹æ ‡è®°ï¼ˆä¿ç•™å½“å‰ä½ç½®æ ‡è®°ï¼‰
            markers.forEach(marker => {
                if (marker !== currentPositionMarker) {
                    map.remove(marker);
                }
            });
            markers = currentPositionMarker ? [currentPositionMarker] : [];
            
            stories.forEach(story => {
                const marker = new AMap.Marker({
                    position: [story.lng, story.lat],
                    map: map,
                    title: story.placeName,
                    content: '<div style="background:#27ae60;color:white;border-radius:50%;width:20px;height:20px;text-align:center;line-height:20px;">ğŸ“–</div>',
                    offset: new AMap.Pixel(-10, -10)
                });
                
                marker.on('click', () => {
                    highlightStoryCard(story.id);
                    const infoWindow = new AMap.InfoWindow({
                        content: `
                            <div style="padding:10px;max-width:250px;">
                                <h4 style="margin:0 0 5px 0;">${story.placeName}</h4>
                                <p style="color:#666;font-size:12px;margin:0 0 8px 0;">${story.time}</p>
                                <div style="font-size:13px;line-height:1.4;max-height:80px;overflow:hidden;">
                                    ${story.content.replace(/<[^>]+>/g, '').substring(0, 80)}...
                                </div>
                                <button onclick="editStory('${story.id}')" style="background:#3498db;color:white;border:none;padding:5px 10px;border-radius:4px;margin-top:8px;cursor:pointer;">ç¼–è¾‘</button>
                            </div>
                        `
                    });
                    infoWindow.open(map, [story.lng, story.lat]);
                });
                
                markers.push(marker);
            });
            
            updateRouteLine();
        }

        // æ¸²æŸ“æ•…äº‹åˆ—è¡¨
        function renderStoryList() {
            const container = document.getElementById('storiesList');
            
            if (stories.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;padding:40px 20px;color:#95a5a6;">
                        <p style="font-size:1.2rem;margin-bottom:10px;">è¿˜æ²¡æœ‰æ•…äº‹è®°å½•</p>
                        <p>ç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®ï¼Œç„¶åç‚¹å‡»"è®°å½•æ•…äº‹"æŒ‰é’®å¼€å§‹è®°å½•</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = stories.map(story => `
                <div class="story-card" data-id="${story.id}" onclick="focusOnStory('${story.id}')">
                    <div class="story-header">
                        <div class="story-title">${story.title}</div>
                        <div class="story-time">${story.time}</div>
                    </div>
                    <div class="story-location">ğŸ“ ${story.placeName}</div>
                    <div class="story-preview">${story.content.replace(/<[^>]+>/g, '').substring(0, 100)}...</div>
                </div>
            `).join('');
        }

        // èšç„¦åˆ°æ•…äº‹åœ°ç‚¹
        function focusOnStory(storyId) {
            const story = stories.find(s => s.id === storyId);
            if (story && map) {
                map.setCenter([story.lng, story.lat]);
                map.setZoom(16);
                highlightStoryCard(storyId);
            }
        }

        // é«˜äº®æ•…äº‹å¡ç‰‡
        function highlightStoryCard(storyId) {
            document.querySelectorAll('.story-card').forEach(card => {
                card.classList.remove('active');
            });
            const card = document.querySelector(`.story-card[data-id="${storyId}"]`);
            if (card) card.classList.add('active');
        }

        // ç¼–è¾‘æ•…äº‹
        function editStory(storyId) {
            const story = stories.find(s => s.id === storyId);
            if (!story) return;
            
            currentPlace = {
                name: story.placeName,
                location: { lng: story.lng, lat: story.lat },
                address: story.address
            };
            
            openEditor(currentPlace, storyId);
        }

        // æ›´æ–°è·¯çº¿è¿çº¿
        function updateRouteLine() {
            if (!map) return;
            
            if (routeLine) {
                map.remove(routeLine);
                routeLine = null;
            }
            
            if (stories.length < 2 || !isRouteVisible) return;
            
            const sortedStories = [...stories].sort((a, b) => a.timestamp - b.timestamp);
            const linePath = sortedStories.map(s => [s.lng, s.lat]);
            
            routeLine = new AMap.Polyline({
                path: linePath,
                strokeColor: "#3498db",
                strokeOpacity: 0.8,
                strokeWeight: 4,
                strokeStyle: "solid"
            });
            
            map.add(routeLine);
            map.setFitView();
        }

        // åˆ‡æ¢è·¯çº¿æ˜¾ç¤º
        function toggleRoute() {
            isRouteVisible = !isRouteVisible;
            document.getElementById('toggleRoute').textContent = 
                isRouteVisible ? 'ğŸ“ éšè—è·¯çº¿å›¾' : 'ğŸ“ æ˜¾ç¤ºè·¯çº¿å›¾';
            updateRouteLine();
        }

        // ç¼–è¾‘å™¨åŠŸèƒ½
        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('storyEditor').focus();
        }
        
        // æ˜¾ç¤ºå›¾ç‰‡ä¸Šä¼ é€‰é¡¹
        function showImageUpload() {
            document.getElementById('imageUploadModal').style.display = 'flex';
        }
        
        // å…³é—­å›¾ç‰‡ä¸Šä¼ 
        function closeImageUpload() {
            document.getElementById('imageUploadModal').style.display = 'none';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imagePreview').src = '';
        }
        
        // æ‰“å¼€ç›¸æœº
        function openCamera() {
            document.getElementById('cameraInput').click();
        }
        
        // æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨
        function openFilePicker() {
            document.getElementById('fileInput').click();
        }
        
        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        function handleImageUpload(file) {
            if (!file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const imgData = e.target.result;
                
                // æ˜¾ç¤ºé¢„è§ˆ
                const preview = document.getElementById('imagePreview');
                preview.src = imgData;
                preview.style.display = 'block';
                
                // æ’å…¥åˆ°ç¼–è¾‘å™¨
                setTimeout(() => {
                    insertImageToEditor(imgData);
                    closeImageUpload();
                }, 1000);
            };
            reader.readAsDataURL(file);
        }
        
        // å°†å›¾ç‰‡æ’å…¥åˆ°ç¼–è¾‘å™¨
        function insertImageToEditor(imgData) {
            const editor = document.getElementById('storyEditor');
            const img = `<img src="${imgData}" style="max-width:100%;border-radius:8px;margin:10px 0;" alt="æ•…äº‹å›¾ç‰‡">`;
            document.execCommand('insertHTML', false, img);
            editor.focus();
        }

        // å…³é—­ç¼–è¾‘å™¨
        function closeEditor() {
            document.getElementById('editorModal').style.display = 'none';
            document.getElementById('storyEditor').innerHTML = '';
            editingStoryId = null;
            // ä¸æ¸…é™¤currentPlaceï¼Œä»¥ä¾¿ä¸‹æ¬¡ä½¿ç”¨
        }

        // è®°å½•æ•…äº‹æŒ‰é’®ç‚¹å‡»
        function recordStory() {
            if (!currentPlace) {
                alert('è¯·å…ˆè·å–ä½ç½®ä¿¡æ¯ã€‚å¯ä»¥ç‚¹å‡»"æ›´æ–°æˆ‘çš„ä½ç½®"æŒ‰é’®æˆ–ç‚¹å‡»åœ°å›¾é€‰æ‹©ä½ç½®ã€‚');
                return;
            }
            openEditor(currentPlace);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–åœ°å›¾...');
            
            // æ£€æŸ¥APIæ˜¯å¦åŠ è½½æˆåŠŸ
            if (!checkAMapLoaded()) {
                // å¦‚æœAPIæœªåŠ è½½ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´å†æ£€æŸ¥
                setTimeout(() => {
                    if (!checkAMapLoaded()) {
                        document.getElementById('keyStatus').innerHTML = 'âŒ é«˜å¾·åœ°å›¾APIåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                        document.getElementById('keyStatus').className = 'status-box error';
                    } else {
                        initMap();
                    }
                }, 2000);
            } else {
                // APIå·²åŠ è½½ï¼Œåˆå§‹åŒ–åœ°å›¾
                initMap();
            }
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('locateButton').addEventListener('click', autoLocate);
            document.getElementById('saveStory').addEventListener('click', saveStory);
            document.getElementById('closeEditor').addEventListener('click', closeEditor);
            document.getElementById('toggleRoute').addEventListener('click', toggleRoute);
            document.getElementById('recordStory').addEventListener('click', recordStory);
            
            // å›¾ç‰‡ä¸Šä¼ äº‹ä»¶
            document.getElementById('cameraInput').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    handleImageUpload(e.target.files[0]);
                }
            });
            
            document.getElementById('fileInput').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    handleImageUpload(e.target.files[0]);
                }
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            document.getElementById('editorModal').addEventListener('click', function(e) {
                if (e.target === this) closeEditor();
            });
            
            document.getElementById('imageUploadModal').addEventListener('click', function(e) {
                if (e.target === this) closeImageUpload();
            });
        };
    </script>
</body>
</html>
